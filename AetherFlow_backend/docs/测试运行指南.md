# AetherFlow 测试运行指南

本指南将帮助你了解如何运行 AetherFlow 后端的测试，以及如何解读测试结果。

## 前提条件

- Node.js 14.x 或更高版本
- npm 6.x 或更高版本
- MongoDB（可选，测试默认使用内存数据库）

## 快速开始

### 运行所有测试

```bash
cd AetherFlow_backend
npm test
```

### 运行测试并生成覆盖率报告

```bash
npm run test:coverage
```

### 监视模式（文件变化时自动运行测试）

```bash
npm run test:watch
```

### 运行单个测试文件或匹配模式

```bash
npm run test:single -- --pattern=auth
```

## 使用测试脚本

我们提供了一个灵活的测试脚本，可以通过多种选项自定义测试运行：

```bash
./scripts/test.sh [选项]
```

### 可用选项

- `--pattern=<模式>`: 指定测试文件模式，例如 "auth"
- `--coverage`: 生成覆盖率报告
- `--watch`: 监视模式
- `--verbose`: 详细输出
- `--no-parallel`: 禁用并行测试
- `--help`: 显示帮助信息

### 示例

运行与认证相关的测试并生成覆盖率报告：

```bash
./scripts/test.sh --pattern=auth --coverage
```

## 测试报告

### 生成测试报告

```bash
npm run test:report
```

这将运行测试并生成详细的测试报告，包括测试结果和覆盖率数据。报告将保存在 `test-results` 目录中。

### 查看测试报告

测试报告包含以下文件：

- `test-results.json`: 原始测试结果
- `coverage/coverage-final.json`: 原始覆盖率数据
- `test-report.json`: 格式化的测试报告

## 测试结果解读

### 测试状态

- ✓ 绿色勾号：测试通过
- ✕ 红色叉号：测试失败
- ○ 空心圆圈：测试被跳过

### 覆盖率指标

- **Statements**: 语句覆盖率，表示代码中有多少语句被测试执行
- **Branches**: 分支覆盖率，表示代码中有多少条件分支被测试执行
- **Functions**: 函数覆盖率，表示代码中有多少函数被测试调用
- **Lines**: 行覆盖率，表示代码中有多少行被测试执行

一般来说，覆盖率达到 80% 以上被认为是良好的测试覆盖。

## 常见问题

### 测试超时

如果测试超时，可能是因为：

1. 数据库连接问题
2. 异步操作没有正确等待
3. 测试超时设置过短

解决方法：

```bash
# 增加超时时间
./scripts/test.sh --no-parallel --verbose
```

### 测试失败

如果测试失败，请检查：

1. 错误信息和堆栈跟踪
2. 测试环境是否正确设置
3. 代码是否有最近的更改

### 内存数据库问题

如果遇到内存数据库问题，可以尝试：

```bash
# 禁用并行测试
./scripts/test.sh --no-parallel
```

## 高级用法

### 自定义测试环境

可以通过环境变量自定义测试环境：

```bash
# 使用真实数据库而不是内存数据库
REAL_DB=true ./scripts/test.sh
```

### 调试测试

可以使用 Node.js 调试器调试测试：

```bash
# 启用调试器
node --inspect-brk node_modules/.bin/jest --runInBand
```

然后在浏览器中打开 `chrome://inspect` 进行调试。

## 参考资料

- [Jest 官方文档](https://jestjs.io/docs/getting-started)
- [Supertest 文档](https://github.com/visionmedia/supertest)
- [MongoDB Memory Server 文档](https://github.com/nodkz/mongodb-memory-server) 