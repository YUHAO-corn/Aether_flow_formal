# AetherFlow 接口实现与联调

## 目录
1. [接口实现情况](#接口实现情况)
   - [用户认证接口](#1-用户认证接口)
   - [提示词管理接口](#2-提示词管理接口)
   - [标签管理接口](#3-标签管理接口)
   - [会话管理接口](#4-会话管理接口)
   - [提示词优化接口](#5-提示词优化接口)
   - [API密钥管理接口](#6-api密钥管理接口)
   - [活动日志管理接口](#7-活动日志管理接口)
2. [实现方式](#实现方式)
   - [架构设计](#架构设计)
   - [技术栈](#技术栈)
   - [安全措施](#安全措施)
3. [前后端接口映射表](#前后端接口映射表)
   - [概述](#概述)
   - [接口映射](#接口映射)
   - [废弃接口](#废弃接口)
4. [前后端接口联调计划](#前后端接口联调计划)
   - [联调环境准备](#联调环境准备)
   - [联调测试计划](#联调测试计划)
   - [联调方法](#联调方法)
   - [联调成功标准](#联调成功标准)
5. [后续工作](#后续工作)
   - [性能优化](#1-性能优化)
   - [安全加固](#2-安全加固)
   - [文档完善](#3-文档完善)

## 接口实现情况

### 1. 用户认证接口

| 接口 | 方法 | 路径 | 状态 | 说明 |
|------|------|------|------|------|
| 注册 | POST | `/api/v1/auth/register` | ✅ | 创建新用户并返回JWT令牌 |
| 登录 | POST | `/api/v1/auth/login` | ✅ | 验证用户凭据并返回JWT令牌 |
| 获取用户信息 | GET | `/api/v1/auth/me` | ✅ | 获取当前登录用户的详细信息 |
| 更新用户信息 | PATCH | `/api/v1/auth/updateMe` | ✅ | 更新当前用户的个人信息 |
| 登出 | POST | `/api/v1/auth/logout` | ✅ | 记录用户登出活动 |

### 2. 提示词管理接口

| 接口 | 方法 | 路径 | 状态 | 说明 |
|------|------|------|------|------|
| 创建提示词 | POST | `/api/v1/prompts` | ✅ | 创建新的提示词 |
| 获取提示词列表 | GET | `/api/v1/prompts` | ✅ | 获取用户的提示词列表，支持分页、排序和筛选 |
| 获取单个提示词 | GET | `/api/v1/prompts/:id` | ✅ | 获取指定ID的提示词详情 |
| 更新提示词 | PATCH | `/api/v1/prompts/:id` | ✅ | 更新指定ID的提示词 |
| 删除提示词 | DELETE | `/api/v1/prompts/:id` | ✅ | 删除指定ID的提示词 |
| 批量获取提示词 | POST | `/api/v1/prompts/batch` | ✅ | 根据ID列表批量获取提示词 |
| 搜索提示词 | GET | `/api/v1/prompts/search` | ✅ | 根据关键词搜索提示词 |
| 自动保存提示词 | POST | `/api/v1/prompts/auto-save` | ✅ | 自动保存用户的提示词 |
| 获取最近使用的提示词 | GET | `/api/v1/prompts/recent` | ✅ | 获取用户最近使用的提示词 |
| 快速搜索提示词 | GET | `/api/v1/prompts/quick-search` | ✅ | 快速搜索提示词，用于自动完成 |
| 增强提示词 | POST | `/api/v1/prompts/enhance` | ✅ | 使用AI增强提示词 |
| 切换收藏状态 | PATCH | `/api/v1/prompts/:id/favorite` | ✅ | 切换提示词的收藏状态 |
| 增加使用次数 | PATCH | `/api/v1/prompts/:id/usage` | ✅ | 增加提示词的使用次数 |

### 3. 标签管理接口

| 接口 | 方法 | 路径 | 状态 | 说明 |
|------|------|------|------|------|
| 创建标签 | POST | `/api/v1/tags` | ✅ | 创建新的标签 |
| 获取标签列表 | GET | `/api/v1/tags` | ✅ | 获取用户的标签列表 |
| 获取单个标签 | GET | `/api/v1/tags/:id` | ✅ | 获取指定ID的标签详情 |
| 更新标签 | PATCH | `/api/v1/tags/:id` | ✅ | 更新指定ID的标签 |
| 删除标签 | DELETE | `/api/v1/tags/:id` | ✅ | 删除指定ID的标签 |
| 获取标签关联的提示词 | GET | `/api/v1/tags/:id/prompts` | ✅ | 获取与指定标签关联的提示词列表 |

### 4. 会话管理接口

| 接口 | 方法 | 路径 | 状态 | 说明 |
|------|------|------|------|------|
| 创建会话 | POST | `/api/v1/conversations` | ✅ | 创建新的会话 |
| 获取会话列表 | GET | `/api/v1/conversations` | ✅ | 获取用户的会话列表，支持分页和筛选 |
| 获取单个会话 | GET | `/api/v1/conversations/:id` | ✅ | 获取指定ID的会话详情 |
| 更新会话 | PATCH | `/api/v1/conversations/:id` | ✅ | 更新指定ID的会话 |
| 删除会话 | DELETE | `/api/v1/conversations/:id` | ✅ | 删除指定ID的会话 |
| 获取会话消息 | GET | `/api/v1/conversations/:id/messages` | ✅ | 获取指定会话的所有消息 |
| 添加消息到会话 | POST | `/api/v1/conversations/:id/messages` | ✅ | 向指定会话添加新消息 |
| 清空会话消息 | DELETE | `/api/v1/conversations/:id/messages` | ✅ | 清空指定会话的所有消息 |

### 5. 提示词优化接口

| 接口 | 方法 | 路径 | 状态 | 说明 |
|------|------|------|------|------|
| 获取客户端配置 | GET | `/api/v1/prompts/optimize/config` | ✅ | 获取提示词优化的客户端配置 |
| 优化提示词 | POST | `/api/v1/prompts/optimize` | ✅ | 使用AI优化提示词 |
| 获取优化历史 | GET | `/api/v1/prompts/optimize/history` | ✅ | 获取用户的提示词优化历史 |
| 获取单个优化记录 | GET | `/api/v1/prompts/optimize/history/:id` | ✅ | 获取指定ID的优化记录详情 |
| 评价优化结果 | POST | `/api/v1/prompts/optimize/history/:id/rate` | ✅ | 对优化结果进行评价 |

### 6. API密钥管理接口

| 接口 | 方法 | 路径 | 状态 | 说明 |
|------|------|------|------|------|
| 添加API密钥 | POST | `/api/v1/api-keys` | ✅ | 添加新的API密钥 |
| 获取API密钥列表 | GET | `/api/v1/api-keys` | ✅ | 获取用户的API密钥列表 |
| 验证API密钥 | POST | `/api/v1/api-keys/:id/verify` | ✅ | 验证指定ID的API密钥是否有效 |
| 更新API密钥 | PATCH | `/api/v1/api-keys/:id` | ✅ | 更新指定ID的API密钥信息 |
| 删除API密钥 | DELETE | `/api/v1/api-keys/:id` | ✅ | 删除指定ID的API密钥 |

### 7. 活动日志管理接口

| 接口 | 方法 | 路径 | 状态 | 说明 |
|------|------|------|------|------|
| 获取活动日志列表 | GET | `/api/v1/activities` | ✅ | 获取用户的活动日志列表，支持分页和筛选 |
| 获取单个活动日志 | GET | `/api/v1/activities/:id` | ✅ | 获取指定ID的活动日志详情 |
| 获取活动统计信息 | GET | `/api/v1/activities/stats` | ✅ | 获取用户活动的统计信息 |
| 清除活动日志 | DELETE | `/api/v1/activities` | ✅ | 清除用户的活动日志，支持条件筛选 |

## 实现方式

### 架构设计

AetherFlow后端采用了模块化的架构设计，主要包括以下几个部分：

1. **路由层（Routes）**：定义API端点和HTTP方法，将请求转发给相应的控制器。
2. **控制器层（Controllers）**：处理请求，调用服务层的方法，返回响应。
3. **服务层（Services）**：实现业务逻辑，与数据库交互。
4. **模型层（Models）**：定义数据结构和数据库模式。
5. **中间件（Middlewares）**：处理认证、错误处理、请求验证等横切关注点。
6. **工具（Utils）**：提供通用功能，如日志记录、响应格式化等。

### 技术栈

- **Node.js**：JavaScript运行时环境
- **Express**：Web框架
- **MongoDB**：NoSQL数据库
- **Mongoose**：MongoDB对象建模工具
- **JWT**：用于用户认证
- **Jest**：测试框架

### 安全措施

1. **认证与授权**：使用JWT进行用户认证，中间件确保只有授权用户能访问受保护的资源。
2. **输入验证**：使用验证中间件验证请求数据，防止恶意输入。
3. **错误处理**：全局错误处理中间件，确保敏感错误信息不会泄露给客户端。
4. **数据加密**：敏感数据（如API密钥）在存储前进行加密。
5. **CORS配置**：限制跨域请求，只允许指定的源访问API。
6. **速率限制**：防止暴力攻击和DoS攻击。

## 前后端接口映射表

### 概述
本部分提供了前端期望的接口与后端实现的映射关系，用于指导API实现和前后端集成。

### 接口映射

#### 认证接口

| 前端期望接口 | 后端实现状态 | 优先级 | 复用性评估 | 备注 |
|------------|------------|-------|----------|------|
| `/auth/register` | 已实现 | 高 | 高 | 用户注册接口 |
| `/auth/login` | 已实现 | 高 | 高 | 用户登录接口 |
| `/auth/logout` | 已实现 | 高 | 高 | 用户登出接口 |
| `/auth/me` (GET) | 已实现 | 高 | 高 | 获取当前用户信息 |
| `/auth/me` (PUT) | 已实现 | 中 | 高 | 更新用户信息 |
| `/auth/password` | 已实现 | 中 | 高 | 修改密码 |

#### 提示词接口

| 前端期望接口 | 后端实现状态 | 优先级 | 复用性评估 | 备注 |
|------------|------------|-------|----------|------|
| `/prompts` (GET) | 已实现 | 高 | 高 | 获取提示词列表 |
| `/prompts/:id` (GET) | 已实现 | 高 | 高 | 获取单个提示词 |
| `/prompts` (POST) | 已实现 | 高 | 高 | 创建提示词 |
| `/prompts/:id` (PUT) | 已实现 | 高 | 高 | 更新提示词 |
| `/prompts/:id` (DELETE) | 已实现 | 高 | 高 | 删除提示词 |
| `/prompts/auto-save` | 已实现 | 高 | 高 | 自动保存提示词 |
| `/prompts/quick-search` | 已实现 | 中 | 高 | 快速搜索提示词 |
| `/prompts/batch` | 已实现 | 中 | 中 | 批量获取提示词 |
| `/prompts/recent` | 已实现 | 中 | 高 | 获取最近使用的提示词 |

#### 标签接口

| 前端期望接口 | 后端实现状态 | 优先级 | 复用性评估 | 备注 |
|------------|------------|-------|----------|------|
| `/tags` (GET) | 已实现 | 高 | 高 | 获取标签列表 |
| `/tags` (POST) | 已实现 | 高 | 高 | 创建标签 |
| `/tags/:id` (GET) | 已实现 | 中 | 高 | 获取单个标签 |
| `/tags/:id` (PUT) | 已实现 | 中 | 高 | 更新标签 |
| `/tags/:id` (DELETE) | 已实现 | 中 | 高 | 删除标签 |
| `/tags/:id/prompts` | 已实现 | 中 | 高 | 获取标签关联的提示词 |

#### 提示词优化接口

| 前端期望接口 | 后端实现状态 | 优先级 | 复用性评估 | 备注 |
|------------|------------|-------|----------|------|
| `/optimize/prompt` | 已实现 | 高 | 高 | 优化提示词 |
| `/optimize/history` | 已实现 | 低 | 中 | 获取优化历史 |

### 废弃接口

以下接口已被废弃，不再维护：

| 接口路径 | 替代接口 | 废弃原因 |
|---------|---------|---------|
| `/api/v1/prompts/search` | `/api/v1/prompts?search=关键词` | 统一查询参数格式 |
| `/api/v1/user/profile` | `/api/v1/auth/me` | 功能合并 |

## 前后端接口联调计划

### 联调环境准备

#### 后端环境

1. **配置开发环境**
   - 确保MongoDB数据库已启动
   - 设置必要的环境变量（JWT_SECRET, MONGODB_URI等）
   - 启动后端服务器：`cd AetherFlow_backend && npm run dev`

2. **准备测试数据**
   - 创建测试用户账号
   - 预先创建一些测试用的提示词和标签
   - 准备API密钥测试数据

#### 前端环境

1. **配置API基础URL**
   - 修改前端配置，指向本地后端服务
   - 确保CORS设置正确

2. **禁用Mock数据**
   - 将前端从Mock Service切换到实际API调用
   - 保留Mock数据作为参考

### 联调测试计划

#### 1. 用户认证流程

| 接口 | 前端组件 | 测试用例 | 预期结果 |
|------|---------|---------|---------|
| POST `/api/v1/auth/register` | 注册表单 | 注册新用户 | 成功创建用户并返回token |
| POST `/api/v1/auth/login` | 登录表单 | 使用正确凭据登录 | 成功登录并返回token |
| GET `/api/v1/auth/me` | 用户信息页 | 获取当前用户信息 | 返回用户详细信息 |
| PATCH `/api/v1/auth/updateMe` | 用户设置页 | 更新用户信息 | 成功更新并返回更新后的信息 |

#### 2. 提示词管理流程

| 接口 | 前端组件 | 测试用例 | 预期结果 |
|------|---------|---------|---------|
| POST `/api/v1/prompts` | 创建提示词表单 | 创建新提示词 | 成功创建并返回提示词信息 |
| GET `/api/v1/prompts` | 提示词列表页 | 获取提示词列表 | 返回分页的提示词列表 |
| GET `/api/v1/prompts/:id` | 提示词详情页 | 获取单个提示词 | 返回提示词详细信息 |
| PATCH `/api/v1/prompts/:id` | 编辑提示词表单 | 更新提示词 | 成功更新并返回更新后的信息 |
| DELETE `/api/v1/prompts/:id` | 提示词列表页 | 删除提示词 | 成功删除提示词 |
| POST `/api/v1/prompts/batch` | 批量操作组件 | 批量获取提示词 | 返回指定ID的提示词列表 |
| GET `/api/v1/prompts/search` | 搜索组件 | 搜索提示词 | 返回匹配的提示词列表 |

#### 3. 标签管理流程

| 接口 | 前端组件 | 测试用例 | 预期结果 |
|------|---------|---------|---------|
| POST `/api/v1/tags` | 创建标签表单 | 创建新标签 | 成功创建并返回标签信息 |
| GET `/api/v1/tags` | 标签列表页 | 获取标签列表 | 返回标签列表 |
| GET `/api/v1/tags/:id` | 标签详情页 | 获取单个标签 | 返回标签详细信息 |
| PATCH `/api/v1/tags/:id` | 编辑标签表单 | 更新标签 | 成功更新并返回更新后的信息 |
| DELETE `/api/v1/tags/:id` | 标签列表页 | 删除标签 | 成功删除标签 |
| GET `/api/v1/tags/:id/prompts` | 标签详情页 | 获取标签关联的提示词 | 返回关联的提示词列表 |

#### 4. 会话管理流程

| 接口 | 前端组件 | 测试用例 | 预期结果 |
|------|---------|---------|---------|
| POST `/api/v1/conversations` | 创建会话组件 | 创建新会话 | 成功创建并返回会话信息 |
| GET `/api/v1/conversations` | 会话列表页 | 获取会话列表 | 返回分页的会话列表 |
| GET `/api/v1/conversations/:id` | 会话详情页 | 获取单个会话 | 返回会话详细信息 |
| PATCH `/api/v1/conversations/:id` | 编辑会话组件 | 更新会话 | 成功更新并返回更新后的信息 |
| DELETE `/api/v1/conversations/:id` | 会话列表页 | 删除会话 | 成功删除会话 |
| POST `/api/v1/conversations/:id/messages` | 会话详情页 | 添加消息到会话 | 成功添加消息并返回更新后的会话 |

#### 5. 提示词优化流程

| 接口 | 前端组件 | 测试用例 | 预期结果 |
|------|---------|---------|---------|
| POST `/api/v1/optimize` | 提示词优化页 | 优化提示词 | 返回优化后的提示词 |
| GET `/api/v1/optimize/history` | 优化历史页 | 获取优化历史 | 返回分页的优化历史列表 |
| GET `/api/v1/optimize/history/:id` | 优化详情页 | 获取单个优化记录 | 返回优化记录详细信息 |
| POST `/api/v1/optimize/history/:id/rate` | 优化详情页 | 评价优化结果 | 成功保存评价并返回确认 |

#### 6. API密钥管理流程

| 接口 | 前端组件 | 测试用例 | 预期结果 |
|------|---------|---------|---------|
| POST `/api/v1/api-keys` | 添加API密钥表单 | 添加API密钥 | 成功添加并返回密钥信息 |
| GET `/api/v1/api-keys` | API密钥列表页 | 获取API密钥列表 | 返回密钥列表 |
| DELETE `/api/v1/api-keys/:id` | API密钥列表页 | 删除API密钥 | 成功删除密钥 |

#### 7. 活动日志管理流程

| 接口 | 前端组件 | 测试用例 | 预期结果 |
|------|---------|---------|---------|
| GET `/api/v1/activities` | 活动日志列表页 | 获取活动日志列表 | 返回分页的活动日志列表 |
| GET `/api/v1/activities/:id` | 活动日志详情页 | 获取单个活动日志 | 返回活动日志详细信息 |
| GET `/api/v1/activities/stats` | 活动统计页 | 获取活动统计数据 | 返回活动统计信息 |
| DELETE `/api/v1/activities` | 活动日志列表页 | 清除活动日志 | 成功清除指定条件的活动日志 |

### 联调方法

#### 1. 接口测试工具

使用Postman或类似工具先测试后端API，确保API正常工作：

```bash
# 示例：测试登录接口
curl -X POST http://localhost:3000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}'
```

#### 2. 前端集成测试

1. **逐个功能模块测试**
   - 从用户认证开始，确保登录/注册正常
   - 依次测试提示词管理、标签管理等功能

2. **端到端测试**
   - 测试完整的用户流程，如：注册->登录->创建提示词->添加标签->优化提示词

#### 3. 问题记录与修复

使用以下表格记录联调过程中发现的问题：

| 问题ID | 接口 | 问题描述 | 解决方案 | 状态 |
|-------|------|---------|---------|------|
| 001 | `/api/v1/auth/login` | 示例：返回格式与前端期望不符 | 调整后端响应格式 | 已解决 |

### 联调成功标准

1. 所有接口能够正确响应前端请求
2. 数据格式与前端期望一致
3. 所有业务流程能够正常完成
4. 无明显的性能问题
5. 错误处理机制正常工作

## 后续工作

### 1. 性能优化

1. **数据库查询优化**：
   - 添加适当的索引
   - 优化查询语句
   - 实现数据分页和懒加载

2. **缓存机制**：
   - 实现Redis缓存
   - 缓存频繁访问的数据
   - 实现缓存失效策略

3. **并发处理**：
   - 优化并发请求处理
   - 实现任务队列

### 2. 安全加固

1. **安全审计**：
   - 进行代码安全审计
   - 检查潜在的安全漏洞

2. **日志增强**：
   - 完善日志记录
   - 实现安全事件监控

3. **备份策略**：
   - 实现数据库定期备份
   - 制定灾难恢复计划

### 3. 文档完善

1. **API文档更新**：
   - 确保文档与实际实现一致
   - 添加更多示例和使用说明

2. **开发文档**：
   - 完善开发指南
   - 添加架构图和流程图

3. **部署文档**：
   - 编写部署指南
   - 提供环境配置说明 