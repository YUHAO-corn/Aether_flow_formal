# AetherFlow 开发指南

## 目录
1. [项目规范](#项目规范)
   - [代码风格规范](#代码风格规范)
   - [目录结构规范](#目录结构规范)
   - [版本控制规范](#版本控制规范)
   - [文档规范](#文档规范)
   - [测试规范](#测试规范)
   - [安全规范](#安全规范)
   - [性能规范](#性能规范)
   - [协作规范](#协作规范)
   - [发布规范](#发布规范)
2. [开发环境搭建](#开发环境搭建)
   - [系统要求](#系统要求)
   - [推荐工具](#推荐工具)
   - [环境安装步骤](#环境安装步骤)
   - [前端环境配置](#前端环境配置)
   - [后端环境配置](#后端环境配置)
   - [数据库设置](#数据库设置)
   - [开发工作流](#开发工作流)
   - [常见问题解决](#常见问题解决)
   - [开发最佳实践](#开发最佳实践)
   - [参考资源](#参考资源)

## 项目规范

### 代码风格规范

#### 通用规范
1. 使用UTF-8编码
2. 使用LF（\n）作为行结束符
3. 文件末尾保留一个空行
4. 缩进使用2个空格（不使用Tab）
5. 行长度不超过100个字符
6. 删除尾随空格
7. 使用分号结束语句

#### JavaScript/TypeScript规范
1. 使用ESLint进行代码检查
2. 使用Prettier进行代码格式化
3. 优先使用ES6+语法特性
4. 使用camelCase命名变量和函数
5. 使用PascalCase命名类和组件
6. 使用UPPER_CASE命名常量
7. 避免使用var，优先使用const，其次使用let
8. 优先使用箭头函数
9. 使用模板字符串代替字符串拼接
10. 使用解构赋值
11. 使用async/await代替Promise链

#### CSS/SCSS规范
1. 使用BEM命名规范
2. 使用SCSS预处理器
3. 避免使用!important
4. 使用相对单位（rem, em, %）代替绝对单位（px）
5. 组件样式使用模块化方案（CSS Modules或styled-components）

#### HTML规范
1. 使用语义化标签
2. 属性使用双引号
3. 自闭合标签使用斜杠结尾（如`<img />`, `<br />`）
4. 使用小写标签和属性名

### React/Vue组件规范
1. 组件文件名使用PascalCase（如`UserProfile.tsx`）
2. 每个文件只包含一个组件
3. 组件属性按字母顺序排列
4. 组件内部方法按以下顺序排列：
   - 生命周期方法
   - 事件处理方法
   - 渲染方法
5. 使用函数组件和Hooks代替类组件
6. 提取可复用逻辑到自定义Hooks

### 目录结构规范

#### 前端目录结构
```
src/
├── assets/         # 静态资源（图片、字体等）
├── components/     # 通用组件
│   ├── common/     # 基础UI组件
│   └── layout/     # 布局组件
├── hooks/          # 自定义Hooks
├── pages/          # 页面组件
├── services/       # API服务
├── store/          # 状态管理
├── styles/         # 全局样式
├── types/          # TypeScript类型定义
├── utils/          # 工具函数
└── App.tsx         # 应用入口
```

#### 后端目录结构
```
src/
├── config/         # 配置文件
├── controllers/    # 控制器
├── middlewares/    # 中间件
├── models/         # 数据模型
├── routes/         # 路由定义
├── services/       # 业务逻辑
├── utils/          # 工具函数
└── app.js          # 应用入口
```

### 版本控制规范

#### 分支管理
1. 主分支：
   - `main`：稳定版本，用于生产环境
   - `develop`：开发版本，用于集成测试

2. 功能分支：
   - 命名格式：`feature/功能名称`
   - 从`develop`分支创建
   - 完成后合并回`develop`分支

3. 修复分支：
   - 命名格式：`bugfix/问题描述`
   - 从`develop`分支创建
   - 完成后合并回`develop`分支

4. 热修复分支：
   - 命名格式：`hotfix/问题描述`
   - 从`main`分支创建
   - 完成后同时合并回`main`和`develop`分支

5. 发布分支：
   - 命名格式：`release/版本号`
   - 从`develop`分支创建
   - 完成后同时合并回`main`和`develop`分支

#### 提交规范
1. 提交信息格式：
   ```
   <类型>(<范围>): <简短描述>
   
   <详细描述>
   
   <关联的问题>
   ```

2. 类型字段：
   - `feat`：新功能
   - `fix`：Bug修复
   - `docs`：文档更新
   - `style`：代码风格调整（不影响功能）
   - `refactor`：代码重构
   - `perf`：性能优化
   - `test`：测试相关
   - `chore`：构建过程或辅助工具变动

3. 范围字段（可选）：
   - 指明修改的模块或组件

4. 示例：
   ```
   feat(prompt-library): 添加提示词卡片排序功能
   
   - 支持按时间排序
   - 支持按使用频率排序
   - 支持按收藏状态排序
   
   Closes #123
   ```

#### 版本号规范
遵循语义化版本（Semantic Versioning）规范：
- 主版本号（Major）：不兼容的API变更
- 次版本号（Minor）：向下兼容的功能性新增
- 修订号（Patch）：向下兼容的问题修正

### 文档规范

#### 代码注释
1. 文件头注释：
   ```javascript
   /**
    * @file 文件描述
    * @author 作者名
    * @date 创建日期
    */
   ```

2. 函数/方法注释：
   ```javascript
   /**
    * 函数描述
    * @param {类型} 参数名 - 参数描述
    * @returns {类型} 返回值描述
    * @example
    * // 使用示例
    * const result = someFunction('example');
    */
   ```

3. 类注释：
   ```javascript
   /**
    * 类描述
    * @class
    * @classdesc 详细描述
    */
   ```

#### 文档文件
1. README.md：
   - 项目简介
   - 安装说明
   - 使用示例
   - 贡献指南
   - 许可证信息

2. CHANGELOG.md：
   - 版本号
   - 发布日期
   - 变更内容（新增、修改、删除）

3. API文档：
   - 使用OpenAPI/Swagger规范
   - 包含请求参数、响应格式、错误码等

### 测试规范

#### 单元测试
1. 使用Jest作为测试框架
2. 测试文件命名：`*.test.js`或`*.spec.js`
3. 测试覆盖率要求：
   - 核心业务逻辑：>80%
   - 工具函数：>90%
4. 测试用例命名应清晰表达测试内容

#### 端到端测试
1. 使用Cypress作为E2E测试框架
2. 覆盖关键用户流程
3. 测试环境与生产环境尽量一致

### 安全规范

#### 代码安全
1. 避免使用`eval`和`Function`构造函数
2. 避免使用`innerHTML`，使用`textContent`代替
3. 使用参数化查询防止SQL注入
4. 对用户输入进行验证和转义

#### 认证与授权
1. 使用HTTPS进行通信
2. 敏感信息不得硬编码在源代码中
3. 密码必须加密存储
4. 实现适当的访问控制

### 性能规范

#### 前端性能
1. 使用懒加载减少初始加载时间
2. 压缩静态资源（JS、CSS、图片）
3. 使用CDN加速静态资源加载
4. 减少HTTP请求次数
5. 避免不必要的DOM操作

#### 后端性能
1. 使用数据库索引优化查询
2. 实现适当的缓存策略
3. 大型计算任务异步处理
4. 定期进行性能测试和优化

### 协作规范

#### 代码审查
1. 所有代码必须经过至少一人审查才能合并
2. 审查重点：
   - 代码质量和风格
   - 功能完整性
   - 测试覆盖率
   - 文档完整性
3. 审查意见应具体明确，避免模糊表述

#### 问题跟踪
1. 使用GitHub Issues或JIRA跟踪问题
2. 问题描述应包含：
   - 问题概述
   - 复现步骤
   - 预期行为
   - 实际行为
   - 环境信息
3. 使用标签对问题进行分类（如`bug`, `feature`, `enhancement`）

### 发布规范

#### 发布流程
1. 从`develop`分支创建`release`分支
2. 在`release`分支上进行最终测试和修复
3. 更新版本号和CHANGELOG
4. 合并到`main`分支并打标签
5. 部署到生产环境
6. 合并回`develop`分支

#### 发布检查清单
1. 所有测试通过
2. 文档已更新
3. 版本号和CHANGELOG已更新
4. 性能指标符合要求
5. 安全检查通过

## 开发环境搭建

### 系统要求

1. 操作系统：
   - Windows 10+
   - macOS 10.15+
   - Ubuntu 20.04+

2. 基础软件：
   - Node.js v16.x或更高版本
   - npm v8.x或更高版本
   - Git v2.x或更高版本
   - Docker和Docker Compose（可选）

### 推荐工具

1. 编辑器：
   - Visual Studio Code

2. 浏览器：
   - Google Chrome
   - Microsoft Edge

3. API测试工具：
   - Postman
   - Insomnia

4. 数据库管理工具：
   - MongoDB Compass

### 环境安装步骤

#### 1. 安装Node.js和npm

##### Windows
1. 访问 [Node.js官网](https://nodejs.org/)
2. 下载并安装LTS版本
3. 验证安装：
   ```bash
   node --version
   npm --version
   ```

##### macOS
```bash
# 使用Homebrew
brew install node

# 验证安装
node --version
npm --version
```

##### Linux (Ubuntu)
```bash
curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

#### 2. 安装Git

##### Windows
1. 访问 [Git官网](https://git-scm.com/)
2. 下载并安装最新版本
3. 验证安装：
   ```bash
   git --version
   ```

##### macOS
```bash
brew install git
```

##### Linux (Ubuntu)
```bash
sudo apt-get update
sudo apt-get install git
```

#### 3. 安装Docker和Docker Compose（可选）

##### Windows/macOS
1. 访问 [Docker Desktop官网](https://www.docker.com/products/docker-desktop)
2. 下载并安装Docker Desktop
3. 验证安装：
   ```bash
   docker --version
   docker-compose --version
   ```

##### Linux (Ubuntu)
```bash
# 安装Docker
sudo apt-get update
sudo apt-get install docker.io

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.10.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

#### 4. 安装Visual Studio Code（推荐）

##### Windows/macOS/Linux
1. 访问 [VS Code官网](https://code.visualstudio.com/)
2. 下载并安装适合你操作系统的版本

##### 推荐扩展
- ESLint
- Prettier
- Tailwind CSS IntelliSense
- Docker
- MongoDB for VS Code
- React Developer Tools
- Chrome Debugger

#### 5. 克隆项目仓库

```bash
git clone https://github.com/yourusername/AetherFlow_v1.git
cd AetherFlow_v1
```

### 前端环境配置

#### 浏览器插件（AetherFlow_plugin_front）
```bash
# 进入插件目录
cd AetherFlow_plugin_front

# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

#### 加载未打包的插件到Chrome
1. 打开Chrome浏览器
2. 访问 `chrome://extensions/`
3. 启用"开发者模式"
4. 点击"加载已解压的扩展程序"
5. 选择`AetherFlow_plugin_front/dist`目录

#### 网页端（AetherFlow_web_front）
```bash
# 进入网页端目录
cd AetherFlow_web_front

# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

### 后端环境配置

#### 方法一：本地开发
```bash
# 创建后端目录（如果不存在）
mkdir -p AetherFlow_backend
cd AetherFlow_backend

# 初始化Node.js项目
npm init -y

# 安装核心依赖
npm install express mongoose jsonwebtoken dotenv cors helmet winston morgan

# 安装开发依赖
npm install --save-dev nodemon eslint jest supertest

# 创建基本目录结构
mkdir -p src/{controllers,models,routes,middlewares,services,utils,config}

# 创建环境变量文件
touch .env .env.example
```

#### 方法二：使用Docker（推荐）
1. 创建`docker-compose.yml`文件：
```yaml
version: '3.8'

services:
  api:
    build: ./AetherFlow_backend
    ports:
      - "3000:3000"
    volumes:
      - ./AetherFlow_backend:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - MONGO_URI=mongodb://mongo:27017/aetherflow
      - JWT_SECRET=your_jwt_secret
    depends_on:
      - mongo
    command: npm run dev

  mongo:
    image: mongo:latest
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db

  mongo-express:
    image: mongo-express
    ports:
      - "8081:8081"
    environment:
      - ME_CONFIG_MONGODB_SERVER=mongo
    depends_on:
      - mongo

volumes:
  mongo-data:
```

2. 启动Docker容器：
```bash
docker-compose up -d
```

#### 配置环境变量

##### 后端环境变量（.env文件）
```
# 服务器配置
PORT=3000
NODE_ENV=development

# 数据库配置
MONGO_URI=mongodb://localhost:27017/aetherflow

# JWT配置
JWT_SECRET=your_jwt_secret
JWT_EXPIRES_IN=24h

# 跨域配置
CORS_ORIGIN=http://localhost:5173

# 日志配置
LOG_LEVEL=debug

# 大模型API配置
AI_API_KEY=your_api_key
AI_API_URL=https://api.openai.com/v1
```

##### 前端环境变量（.env文件）
```
# 浏览器插件
VITE_API_URL=http://localhost:3000/api/v1

# 网页端
VITE_API_URL=http://localhost:3000/api/v1
```

### 数据库设置

#### 本地MongoDB
1. 安装MongoDB：
   - [Windows安装指南](https://docs.mongodb.com/manual/tutorial/install-mongodb-on-windows/)
   - [macOS安装指南](https://docs.mongodb.com/manual/tutorial/install-mongodb-on-os-x/)
   - [Linux安装指南](https://docs.mongodb.com/manual/administration/install-on-linux/)

2. 启动MongoDB服务：
   ```bash
   # Windows
   net start MongoDB

   # macOS/Linux
   sudo systemctl start mongod
   ```

3. 创建数据库：
   ```bash
   # 连接MongoDB
   mongo

   # 创建数据库
   use aetherflow
   ```

#### Docker MongoDB（如果使用Docker）
数据库会在`docker-compose up`时自动创建

#### 安装浏览器扩展开发工具

##### Chrome扩展开发
1. 安装[Chrome Extension Manifest V3 Boilerplate](https://github.com/lxieyang/chrome-extension-boilerplate-react)（可选）
2. 安装React Developer Tools浏览器扩展

### 开发工作流

#### 前端开发工作流
1. 启动开发服务器：
   ```bash
   # 浏览器插件
   cd AetherFlow_plugin_front
   npm run dev

   # 网页端
   cd AetherFlow_web_front
   npm run dev
   ```

2. 浏览器访问：
   - 网页端：http://localhost:5173
   - 浏览器插件：通过Chrome扩展页面加载

3. 代码变更会自动热重载

#### 后端开发工作流
1. 启动开发服务器：
   ```bash
   # 本地开发
   cd AetherFlow_backend
   npm run dev

   # Docker开发
   docker-compose up
   ```

2. API访问：http://localhost:3000

3. 数据库管理：
   - MongoDB Compass连接：mongodb://localhost:27017
   - 或使用Mongo Express：http://localhost:8081（如果使用Docker）

### 常见问题解决

#### 前端常见问题

##### 1. 依赖安装失败
```bash
# 清除npm缓存
npm cache clean --force

# 使用淘宝镜像
npm config set registry https://registry.npmmirror.com

# 重新安装
npm install
```

##### 2. vite命令无法直接运行
- **问题描述**：vite虽然已在package.json的devDependencies中，但可能存在权限或路径问题
- **解决方案**：使用npx vite替代直接调用vite
```bash
# 替代直接调用vite
npx vite
```

##### 3. 开发服务器端口占用
- **问题描述**：之前的开发服务器可能未正常关闭，导致端口被占用
- **解决方案**：
  1. 创建cleanup.sh脚本清理占用的端口
  ```bash
  #!/bin/bash
  # cleanup.sh
  # 查找占用5173端口的进程并终止
  pid=$(lsof -t -i:5173)
  if [ -n "$pid" ]; then
    echo "Killing process $pid that is using port 5173"
    kill -9 $pid
  fi
  ```
  2. 确保脚本有执行权限：`chmod +x cleanup.sh`
  3. 在启动开发服务器前运行：`./cleanup.sh && npm run dev`

##### 4. 浏览器插件加载失败
- 确保已启用开发者模式
- 检查dist目录是否存在
- 尝试重新构建插件：`npm run build`
- 在Chrome扩展页面点击"更新"按钮

##### 5. Vite开发服务器端口冲突
```bash
# 修改vite.config.js
export default defineConfig({
  // ...
  server: {
    port: 5174, // 修改为其他端口
  },
});
```

#### 后端常见问题

##### 1. MongoDB连接失败
- 检查MongoDB服务是否运行
- 验证连接字符串是否正确
- 检查网络设置和防火墙

##### 2. 环境变量未加载
- 确保.env文件位于正确位置
- 检查是否已安装dotenv包
- 确保在应用入口处加载了环境变量：`require('dotenv').config()`

##### 3. Docker容器启动失败
- 检查Docker和Docker Compose是否正确安装
- 验证docker-compose.yml文件格式
- 查看容器日志：`docker-compose logs`

### 开发最佳实践

#### 代码风格和质量
1. 使用ESLint和Prettier保持代码风格一致
2. 遵循项目的代码规范
3. 定期运行测试确保代码质量

#### Git工作流
1. 创建功能分支：`git checkout -b feature/your-feature`
2. 定期提交代码：`git commit -m "feat: add new feature"`
3. 推送到远程仓库：`git push origin feature/your-feature`
4. 创建Pull Request进行代码审查

#### 调试技巧
1. 前端调试：
   - 使用浏览器开发者工具
   - 使用React Developer Tools
   - 使用console.log()和debugger语句

2. 后端调试：
   - 使用VS Code调试器
   - 使用nodemon自动重启服务器
   - 使用winston记录详细日志

### 参考资源

#### 官方文档
- [Node.js文档](https://nodejs.org/en/docs/)
- [React文档](https://reactjs.org/docs/getting-started.html)
- [Express文档](https://expressjs.com/)
- [MongoDB文档](https://docs.mongodb.com/)
- [Chrome扩展开发文档](https://developer.chrome.com/docs/extensions/)

#### 学习资源
- [React教程](https://reactjs.org/tutorial/tutorial.html)
- [Express教程](https://expressjs.com/en/starter/installing.html)
- [MongoDB教程](https://docs.mongodb.com/manual/tutorial/)
- [Chrome扩展开发教程](https://developer.chrome.com/docs/extensions/mv3/getstarted/)

#### 工具文档
- [ESLint文档](https://eslint.org/docs/user-guide/getting-started)
- [Prettier文档](https://prettier.io/docs/en/index.html)
- [Docker文档](https://docs.docker.com/)
- [Docker Compose文档](https://docs.docker.com/compose/)

## 功能模块说明

为确保开发过程中对功能模块的理解一致，特此说明各功能模块的定义、职责和实现状态。

### 网页端功能

| 标准命名 | 组件名称 | 功能描述 | 实现状态 |
|---------|---------|---------|---------|
| 提示词管理 | PromptCard, TagNavigation | 展示用户已保存的提示词卡片，支持查看信息、收藏提示词、编辑标签 | ✅ 已完成 |
| 提示词优化/提示词实验室 | PromptLaboratory | 提供提示词优化功能，用户可输入原始提示词，系统返回优化后的版本；同时提供沙盒调试功能，支持与大模型对话测试 | ✅ 已完成 |
| 分析仪表盘 | AnalyticsDashboard | 展示用户提示词使用情况的数据可视化，包括词云图、雷达图等 | ✅ 已完成 |
| 活动日志 | ActivityLog | 记录用户活动，提供统计和查询功能（隐藏功能） | ✅ 已完成 |
| 功能检查工具 | FunctionalityChecker | 检查系统核心功能的可用性（隐藏功能） | ✅ 已完成 |

### 浏览器插件功能

| 标准命名 | 组件名称 | 功能描述 | 实现状态 |
|---------|---------|---------|---------|
| 自动捕获/保存 | AutoSave | 自动捕获用户与AI平台的对话并存储 | ✅ 已完成 |
| 提示词快捷输入 | Prompt Image | 用户输入"/"后显示提示词下拉菜单 | 🔄 开发中 |
| 提示词库 | PromptLibrary | 展示提示词卡片列表，支持插入和复制 | ✅ 已完成 |
| 提示词优化 | PromptEnhancement | 在插件侧边栏提供优化Prompt功能 | ✅ 已完成 |
| 智能建议 | SmartSuggestions | 系统预设提示词卡片，按不同场景和用途分类 | ✅ 已完成 |

### 功能职责分离

为明确功能边界，特此说明：

1. 自动捕获/保存功能仅在浏览器插件中实现，网页端不提供此功能
2. 提示词管理是网页端的核心功能，插件端通过提示词库提供类似但简化的功能
3. 提示词优化在网页端和插件端都有实现，但针对不同使用场景有所区别：
   - 网页端：PromptLaboratory组件，提供更完整的优化体验和沙盒调试功能
   - 插件端：PromptEnhancement组件，提供快速优化功能
4. 分析仪表盘仅在网页端实现
5. 智能建议仅在插件端实现

### 术语统一

为避免混淆，以下是一些需要统一的术语：

1. "资产仪表盘"统一为"分析仪表盘"(AnalyticsDashboard)
2. "Prompt Image"统一为"提示词快捷输入"
3. "系统推荐"和"Suggestion"统一为"智能建议"(SmartSuggestions)
4. "沙盒调试"功能已集成在"提示词实验室"(PromptLaboratory)中，不作为独立功能
5. "Prompt Capture and Save"统一为"自动捕获/保存"(AutoSave)
6. "Prompt library"统一为"提示词库"(PromptLibrary)
7. "Prompt enhancement"统一为"提示词优化"，在插件端为PromptEnhancement，在网页端为PromptLaboratory 