# AetherFlow 测试计划

## 已完成功能测试状态

| 功能模块 | 功能点 | 单元测试 | 集成测试 | 手动测试 | 测试状态 |
|---------|-------|---------|---------|---------|---------|
| **基础架构** | Express应用配置 | ✅ | ✅ | ✅ | 已完成 |
| | MongoDB连接 | ✅ | ✅ | ✅ | 已完成 |
| | 错误处理中间件 | ✅ | ❌ | ❌ | 部分完成 |
| | 认证中间件 | ✅ | ✅ | ❌ | 部分完成 |
| | 日志系统 | ✅ | ❌ | ❌ | 部分完成 |
| | 响应处理工具 | ✅ | ❌ | ❌ | 部分完成 |
| **用户认证** | 用户模型 | ✅ | ✅ | ❌ | 部分完成 |
| | 注册功能 | ✅ | ✅ | ❌ | 部分完成 |
| | 登录功能 | ✅ | ✅ | ❌ | 部分完成 |
| | JWT认证 | ✅ | ✅ | ❌ | 部分完成 |
| | 用户信息更新 | ✅ | ✅ | ❌ | 部分完成 |
| **提示词管理** | 提示词模型 | ✅ | ✅ | ❌ | 部分完成 |
| | 创建提示词 | ✅ | ✅ | ❌ | 部分完成 |
| | 获取提示词列表 | ✅ | ✅ | ❌ | 部分完成 |
| | 更新提示词 | ✅ | ✅ | ❌ | 部分完成 |
| | 删除提示词 | ✅ | ✅ | ❌ | 部分完成 |
| | 自动保存提示词 | ✅ | ✅ | ❌ | 部分完成 |
| | 快速搜索提示词 | ✅ | ✅ | ❌ | 部分完成 |
| | 批量获取提示词 | ✅ | ✅ | ❌ | 部分完成 |
| **标签管理** | 标签模型 | ✅ | ✅ | ❌ | 部分完成 |
| | 创建标签 | ✅ | ✅ | ❌ | 部分完成 |
| | 获取标签列表 | ✅ | ✅ | ❌ | 部分完成 |
| | 更新标签 | ✅ | ✅ | ❌ | 部分完成 |
| | 删除标签 | ✅ | ✅ | ❌ | 部分完成 |
| | 获取标签关联的提示词 | ✅ | ✅ | ❌ | 部分完成 |
| **会话管理** | 会话模型 | ✅ | ✅ | ❌ | 部分完成 |
| | 创建会话 | ✅ | ✅ | ❌ | 部分完成 |
| | 获取会话列表 | ✅ | ✅ | ❌ | 部分完成 |
| | 更新会话 | ✅ | ✅ | ❌ | 部分完成 |
| | 删除会话 | ✅ | ✅ | ❌ | 部分完成 |
| | 添加消息到会话 | ✅ | ✅ | ❌ | 部分完成 |
| | 获取会话消息历史 | ✅ | ✅ | ❌ | 部分完成 |
| | 清空会话消息 | ✅ | ✅ | ❌ | 部分完成 |
| | 导出会话 | ✅ | ✅ | ❌ | 部分完成 |
| | 分享会话 | ✅ | ✅ | ❌ | 部分完成 |
| | 标记会话（收藏/存档） | ✅ | ✅ | ❌ | 部分完成 |
| **活动日志** | 活动日志模型 | ✅ | ✅ | ❌ | 部分完成 |
| | 记录用户活动 | ✅ | ✅ | ❌ | 部分完成 |
| | 获取活动日志 | ✅ | ✅ | ❌ | 部分完成 |
| | 获取活动统计 | ❌ | ✅ | ❌ | 部分完成 |
| | 清除活动日志 | ❌ | ✅ | ❌ | 部分完成 |
| **提示词优化** | 优化历史模型 | ✅ | ✅ | ❌ | 部分完成 |
| | API密钥管理模型 | ✅ | ✅ | ❌ | 部分完成 |
| | 多模型支持 | ✅ | ✅ | ❌ | 部分完成 |
| | 客户端/服务端优化模式 | ✅ | ✅ | ❌ | 部分完成 |
| | 多轮优化支持 | ✅ | ✅ | ❌ | 部分完成 |
| | 优化历史记录 | ✅ | ✅ | ❌ | 部分完成 |
| | 优化结果评价 | ✅ | ✅ | ❌ | 部分完成 |

## 测试优先级

### 高优先级（立即测试）
1. **✅ 活动日志功能**（已完成）
   - ✅ 活动记录API
   - ✅ 活动查询API
   - ✅ 活动统计API
   - ✅ 活动清除API

2. **修复mock-api脚本**
   - 确保模拟API服务器可以正常启动
   - 验证所有模拟端点功能正常

### 中优先级（1-2周内测试）
1. **✅ API密钥管理**（已完成）
   - ✅ API密钥添加
   - ✅ API密钥获取
   - ✅ API密钥删除
   - ✅ API密钥验证
   - ✅ API密钥更新

2. **端到端测试环境搭建**
   - 配置测试框架
   - 设置测试数据

### 低优先级（3-4周内测试）
1. **端到端测试用例**
   - 用户认证流程
   - 提示词管理流程
   - 标签管理流程
   - 会话管理流程
   - 提示词优化流程

2. **性能测试**
   - 负载测试
   - 压力测试
   - 响应时间测试

## 测试方法

### 自动化测试（可通过代码或指令完成）

#### 单元测试
使用Jest框架进行单元测试，主要测试各个功能模块的独立功能。

```bash
# 运行所有单元测试
npm test

# 运行特定模块的测试
npm test -- --testPathPattern=src/tests/auth.test.js
```

#### 集成测试
使用Supertest进行API集成测试，验证API端点的功能和响应。

```bash
# 运行集成测试
npm run test:integration
```

#### 测试覆盖率报告
生成测试覆盖率报告，查看代码测试覆盖情况。

```bash
npm run test:coverage
```

### 需要手动测试的功能

#### 1. 提示词优化功能
由于涉及外部API调用和复杂的交互逻辑，需要手动测试以下场景：

- **不同模型的优化效果**：
  - 使用OpenAI模型优化提示词
  - 使用DeepSeek模型优化提示词
  - 使用Moonshot模型优化提示词
  - 比较不同模型的优化效果

- **多轮优化**：
  - 对同一提示词进行多轮优化
  - 验证每轮优化是否有改进

- **API密钥管理**：
  - 添加不同提供商的API密钥
  - 更新API密钥
  - 删除API密钥
  - 使用无效API密钥测试错误处理

#### 2. 客户端/服务端模式切换
测试在客户端和服务端两种模式下的优化功能：

- **客户端模式**：
  - 前端直接调用AI服务商API
  - 验证数据隐私保护机制

- **服务端模式**：
  - 通过后端调用AI服务商API
  - 验证API密钥管理和权限控制

#### 3. 用户体验测试
需要实际用户参与的测试：

- **界面响应性**：
  - 优化过程的加载动画
  - 结果展示的用户体验

- **错误处理**：
  - API调用失败时的错误提示
  - 网络问题时的降级处理

## 测试数据准备

### 测试用户
```json
{
  "username": "testuser",
  "email": "test@example.com",
  "password": "Test@123456"
}
```

### 测试提示词
```json
{
  "content": "写一篇关于人工智能的文章",
  "response": "人工智能（AI）是计算机科学的一个分支...",
  "platform": "OpenAI",
  "url": "https://chat.openai.com/123456"
}
```

### 测试标签
```json
{
  "name": "AI",
  "color": "#3498db"
}
```

### 测试会话
```json
{
  "model": "gpt-4",
  "title": "AI讨论",
  "messages": [
    {
      "role": "user",
      "content": "什么是人工智能？"
    },
    {
      "role": "assistant",
      "content": "人工智能是指由人创造的、模拟人类智能的系统..."
    }
  ]
}
```

## 测试环境设置

### 本地测试环境
```bash
# 启动MongoDB测试数据库
docker run --name mongodb-test -p 27017:27017 -d mongo:latest

# 设置测试环境变量
export NODE_ENV=test
export MONGODB_URI=mongodb://localhost:27017/aetherflow_test
export JWT_SECRET=test_secret
export ENCRYPTION_KEY=32_bytes_hex_string_for_testing

# 启动测试服务器
npm run dev:test
```

### 模拟API服务
对于提示词优化功能，可以使用模拟服务器来模拟AI服务商API：

```bash
# 启动模拟API服务器
npm run mock-api
```

## 测试报告模板

### 功能测试报告
```
功能名称：[功能名称]
测试日期：[日期]
测试人员：[姓名]

测试用例：
1. [测试用例描述]
   - 预期结果：[预期结果]
   - 实际结果：[实际结果]
   - 状态：[通过/失败]

2. [测试用例描述]
   - 预期结果：[预期结果]
   - 实际结果：[实际结果]
   - 状态：[通过/失败]

问题和建议：
1. [问题描述]
2. [改进建议]
```

### 性能测试报告
```
测试场景：[场景描述]
测试日期：[日期]
测试工具：[工具名称]

测试结果：
- 平均响应时间：[时间]
- 最大响应时间：[时间]
- 每秒请求数：[数量]
- CPU使用率：[百分比]
- 内存使用率：[百分比]

性能瓶颈：
1. [瓶颈描述]

优化建议：
1. [建议描述]
```

## 测试自动化计划

### 持续集成设置
使用GitHub Actions设置持续集成流程，在代码提交时自动运行测试：

```yaml
name: AetherFlow Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
          
    steps:
      - uses: actions/checkout@v2
      
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run tests
        run: npm test
        
      - name: Generate coverage report
        run: npm run test:coverage
```

### 自动化测试脚本
创建自动化测试脚本，简化测试流程：

```bash
#!/bin/bash
# test-all.sh

# 设置测试环境
export NODE_ENV=test
export MONGODB_URI=mongodb://localhost:27017/aetherflow_test
export JWT_SECRET=test_secret
export ENCRYPTION_KEY=32_bytes_hex_string_for_testing

# 运行单元测试
echo "Running unit tests..."
npm test

# 运行集成测试
echo "Running integration tests..."
npm run test:integration

# 生成覆盖率报告
echo "Generating coverage report..."
npm run test:coverage

# 显示结果
echo "Test results:"
cat coverage/summary.txt
```

## 下一步测试计划

1. **✅ 完成活动日志功能的集成测试**（已完成）
   - ✅ 编写活动记录的集成测试
   - ✅ 编写活动查询的集成测试
   - ✅ 编写活动统计的集成测试
   - ✅ 编写活动清除的集成测试

2. **✅ 实现API密钥管理的集成测试**（已完成）
   - ✅ 编写API密钥添加的集成测试
   - ✅ 编写API密钥获取的集成测试
   - ✅ 编写API密钥删除的集成测试
   - ✅ 编写API密钥验证的集成测试
   - ✅ 编写API密钥更新的集成测试

3. **设置端到端测试环境**（3周内）
   - 配置Cypress或Playwright
   - 设置测试数据和环境
   - 编写基础测试框架

4. **编写端到端测试用例**（4周内）
   - 用户认证流程测试
   - 提示词管理流程测试
   - 标签管理流程测试
   - 会话管理流程测试
   - 提示词优化流程测试

5. **修复mock-api脚本问题**（立即）
   - 在package.json中添加mock-api脚本
   - 确保模拟API服务器正常运行
   - 验证所有模拟API端点功能正常

## 测试策略

### 测试目标

#### 质量目标
1. **功能完整性**：确保所有功能按照需求规格正常工作
2. **用户体验**：确保用户界面友好、响应迅速
3. **性能表现**：确保系统在预期负载下性能良好
4. **安全性**：确保系统安全，防止数据泄露和未授权访问
5. **兼容性**：确保系统在不同浏览器和设备上正常工作

#### 测试覆盖率目标
1. **单元测试**：核心业务逻辑覆盖率 > 80%
2. **集成测试**：API端点覆盖率 > 90%
3. **端到端测试**：关键用户流程覆盖率 100%

### 测试类型详细说明

#### 单元测试
- **目的**：验证独立组件和函数的正确性
- **范围**：
  - 前端：React组件、工具函数、Hooks
  - 后端：控制器、服务、工具函数
- **工具**：
  - 前端：Jest, React Testing Library
  - 后端：Jest, Supertest
- **执行频率**：每次代码提交

#### 集成测试
- **目的**：验证多个组件或模块之间的交互
- **范围**：
  - 前端：组件组合、状态管理
  - 后端：API端点、数据库交互
- **工具**：
  - 前端：Jest, React Testing Library
  - 后端：Jest, Supertest, MongoDB Memory Server
- **执行频率**：每日构建

#### 端到端测试
- **目的**：验证整个系统的功能和用户流程
- **范围**：关键用户流程，如：
  - 用户注册和登录
  - Prompt保存和检索
  - Prompt优化
  - 标签管理
- **工具**：Cypress, Playwright
- **执行频率**：每周或重大功能变更

#### 性能测试
- **目的**：验证系统在不同负载下的性能
- **范围**：
  - API响应时间
  - 页面加载时间
  - 数据库查询性能
- **工具**：k6, Lighthouse
- **执行频率**：每月或重大架构变更

#### 安全测试
- **目的**：识别和修复安全漏洞
- **范围**：
  - 认证和授权
  - 数据加密
  - 输入验证
  - 依赖扫描
- **工具**：OWASP ZAP, npm audit, Snyk
- **执行频率**：每季度或重大安全更新

### 测试流程

#### 开发阶段测试
1. **开发人员本地测试**：
   - 编写单元测试
   - 运行本地测试套件
   - 修复失败的测试
2. **代码审查**：
   - 审查测试覆盖率
   - 审查测试质量
   - 确保关键功能有测试覆盖

#### 集成阶段测试
1. **持续集成测试**：
   - 自动运行单元测试和集成测试
   - 验证代码与主分支的兼容性
   - 生成测试报告
2. **功能验证**：
   - QA团队验证新功能
   - 执行手动测试
   - 记录问题

#### 发布前测试
1. **回归测试**：
   - 运行完整的自动化测试套件
   - 验证所有功能正常工作
   - 确保没有引入新的缺陷
2. **性能测试**：
   - 执行负载测试
   - 验证系统性能符合要求
   - 识别性能瓶颈
3. **安全测试**：
   - 执行安全扫描
   - 验证安全控制措施
   - 修复安全漏洞

### 测试自动化

#### 自动化测试框架
- **前端**：Jest + React Testing Library
- **后端**：Jest + Supertest
- **端到端**：Cypress

#### 持续集成/持续部署
- **工具**：GitHub Actions
- **触发条件**：
  - 代码提交到主分支
  - 创建Pull Request
  - 定时触发（每日/每周）
- **自动化流程**：
  1. 代码检查（ESLint, Prettier）
  2. 单元测试
  3. 集成测试
  4. 构建
  5. 部署到测试环境
  6. 端到端测试
  7. 性能测试

### 测试最佳实践

#### 单元测试最佳实践
1. **测试隔离**：每个测试应该独立运行，不依赖其他测试
2. **测试可读性**：测试名称应清晰描述测试内容
3. **测试结构**：使用AAA模式（Arrange-Act-Assert）
4. **模拟外部依赖**：使用模拟对象替代外部依赖
5. **测试边界条件**：测试正常情况、边界情况和错误情况

#### 集成测试最佳实践
1. **测试关键路径**：优先测试核心业务流程
2. **测试数据隔离**：使用测试数据库或内存数据库
3. **测试API契约**：验证API响应格式和状态码
4. **测试数据库交互**：验证数据库操作的正确性
5. **清理测试数据**：测试完成后清理测试数据

#### 端到端测试最佳实践
1. **测试用户流程**：模拟真实用户操作
2. **测试稳定性**：编写稳定的测试，避免脆弱的选择器
3. **测试隔离**：每个测试应该独立运行
4. **测试性能**：监控测试执行时间，优化慢测试
5. **视觉验证**：使用截图比较验证UI变化 

## 提示词优化功能测试

### 单元测试
- [x] 优化提示词API测试
  - [x] 测试成功优化提示词
  - [x] 测试处理缺少必要参数的情况
- [x] API密钥管理测试
  - [x] 测试添加API密钥
  - [x] 测试获取API密钥列表
  - [x] 测试删除API密钥
- [x] 优化历史记录测试
  - [x] 测试获取优化历史列表
  - [x] 测试获取单个优化历史
  - [x] 测试评价优化结果
- [x] 客户端配置测试
  - [x] 测试获取客户端配置

### 集成测试
- [x] 优化提示词API集成测试
  - [x] 测试成功优化提示词并记录活动日志
  - [x] 测试使用用户的API密钥进行优化
  - [x] 测试支持多轮优化
- [x] API密钥管理集成测试
  - [x] 测试添加API密钥
  - [x] 测试获取API密钥列表
  - [x] 测试删除API密钥
- [x] 优化历史记录集成测试
  - [x] 测试获取优化历史列表
  - [x] 测试获取单个优化历史
  - [x] 测试评价优化结果
- [x] 客户端配置集成测试
  - [x] 测试获取客户端配置

### 端到端测试
- [ ] 优化提示词流程测试
  - [ ] 测试用户输入提示词，获取优化结果
  - [ ] 测试用户评价优化结果
  - [ ] 测试用户查看优化历史
- [ ] API密钥管理流程测试
  - [ ] 测试用户添加、查看和删除API密钥
- [ ] 多轮优化流程测试
  - [ ] 测试用户进行多轮优化 

## 测试用例详情

### API密钥管理功能

| 测试用例ID | 测试用例描述 | 测试类型 | 优先级 | 状态 | 测试结果 |
|-----------|------------|---------|-------|------|---------|
| APIKEY-INT-001 | 添加API密钥集成测试 | 集成测试 | 高 | ✅ 已完成 | 通过 |
| APIKEY-INT-002 | 获取API密钥列表集成测试 | 集成测试 | 高 | ✅ 已完成 | 通过 |
| APIKEY-INT-003 | 验证API密钥集成测试 | 集成测试 | 中 | ✅ 已完成 | 通过 |
| APIKEY-INT-004 | 删除API密钥集成测试 | 集成测试 | 高 | ✅ 已完成 | 通过 |
| APIKEY-INT-005 | 更新API密钥集成测试 | 集成测试 | 中 | ✅ 已完成 | 通过 | 

## 高优先级测试

| 功能模块 | 测试类型 | 测试状态 | 测试结果 | 备注 |
| ------- | ------- | ------- | ------- | ---- |
| 用户认证 | 单元测试 | 已完成 | 通过 | 包括注册、登录、密码重置等功能 |
| 用户认证 | 集成测试 | 已完成 | 通过 | 测试API端点与数据库交互 |
| 提示词管理 | 单元测试 | 已完成 | 通过 | 包括创建、更新、删除提示词等功能 |
| 提示词管理 | 集成测试 | 已完成 | 通过 | 测试API端点与数据库交互 |
| 提示词优化 | 单元测试 | 已完成 | 通过 | 测试优化逻辑和服务层功能 |
| 提示词优化 | 集成测试 | 已完成 | 通过 | 测试API端点与外部服务交互 |
| 会话管理 | 单元测试 | 已完成 | 通过 | 包括创建、更新、删除会话等功能 |
| 会话管理 | 集成测试 | 已完成 | 通过 | 测试API端点与数据库交互 |
| 活动日志 | 单元测试 | 已完成 | 通过 | 测试日志记录和查询功能 |
| 活动日志 | 集成测试 | 已完成 | 通过 | 测试API端点与数据库交互 |
| API密钥管理 | 单元测试 | 已完成 | 通过 | 测试密钥生成和验证功能 |
| API密钥管理 | 集成测试 | 已完成 | 通过 | 测试API端点与数据库交互 |

## 测试进度

### 后端测试

- [x] 用户认证功能测试
  - [x] 注册功能
  - [x] 登录功能
  - [x] 密码重置功能
  - [x] 用户信息更新功能
  - [x] 权限验证功能
- [x] 提示词管理功能测试
  - [x] 创建提示词
  - [x] 更新提示词
  - [x] 删除提示词
  - [x] 查询提示词
  - [x] 标签管理
  - [x] 收藏功能
- [x] 提示词优化功能测试
  - [x] 提示词优化请求
  - [x] 优化历史记录
  - [x] 优化评分功能
  - [x] API密钥管理
- [x] 会话管理功能测试
  - [x] 创建会话
  - [x] 更新会话
  - [x] 删除会话
  - [x] 查询会话
  - [x] 消息管理
  - [x] 导出功能
  - [x] 分享功能
  - [x] 标记功能
- [x] 活动日志功能测试
  - [x] 活动记录
  - [x] 活动查询
  - [x] 活动统计
  - [x] 活动清理
- [x] API密钥管理功能测试
  - [x] 密钥创建
  - [x] 密钥验证
  - [x] 密钥删除
  - [x] 密钥查询 