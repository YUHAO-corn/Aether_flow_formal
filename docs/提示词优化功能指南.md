# AetherFlow 提示词优化功能指南

## 概述
本文档整合了AetherFlow项目的提示词优化功能设计的核心内容，作为我们两人协作开发的参考指南。

## 功能目标

提示词优化功能旨在帮助用户改进他们的提示词，使其能够获得更好的AI回复。具体目标包括：

1. 提高提示词的清晰度和具体性
2. 增强提示词的创造性和多样性
3. 优化提示词的结构和格式
4. 提供多种优化风格和选项
5. 支持多轮优化和历史记录

## 当前实现状态

### 后端实现状态
- ✅ 提示词优化API端点
- ✅ 优化历史记录功能
- ✅ 多模型支持（OpenAI、Claude）
- ✅ 优化参数配置
- ✅ 优化质量评估

### 前端实现状态
- ⏳ 优化界面设计（进行中）
- ⏳ 参数控制组件（进行中）
- ❌ 优化结果展示
- ❌ 优化历史记录展示
- ❌ 用户反馈机制

## 优化流程

### 基本流程
1. 用户提交原始提示词
2. 系统分析提示词的特性和质量
3. 系统调用大模型API进行优化
4. 系统返回优化后的提示词
5. 用户可以接受、修改或继续优化

### 详细流程图
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  用户提交   │     │  系统分析   │     │  调用API    │
│  原始提示词 │────▶│  提示词特性 │────▶│  进行优化   │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                                │
┌─────────────┐     ┌─────────────┐     ┌──────▼──────┐
│  用户操作   │     │  展示优化   │     │  返回优化   │
│  结果       │◀────│  结果       │◀────│  结果       │
└─────────────┘     └─────────────┘     └─────────────┘
```

## 优化参数

### 基本参数
- **模型选择**：用户可以选择使用的大模型（如GPT-4、Claude等）
- **优化强度**：控制优化的程度（轻微、中等、强烈）
- **优化方向**：指定优化的重点（清晰度、创造性、专业性等）
- **保留关键词**：用户可以指定必须保留的关键词或短语

### 高级参数
- **温度**：控制输出的随机性（0.0-1.0）
- **最大长度**：控制优化后提示词的最大长度
- **格式要求**：指定输出格式（如Markdown、JSON等）
- **语言风格**：指定语言风格（如正式、技术性、对话式等）

## 优化策略

### 清晰度优化
- 消除模糊和歧义表达
- 添加具体的细节和示例
- 使用明确的指令和要求
- 改进逻辑结构和连贯性

### 创造性优化
- 引入新的视角和思路
- 添加创新性的元素
- 鼓励非常规思考
- 增加多样性和灵活性

### 专业性优化
- 使用领域特定术语
- 添加专业背景和上下文
- 引入行业标准和最佳实践
- 提高技术准确性

### 简洁性优化
- 删除冗余和重复内容
- 简化复杂表达
- 聚焦核心问题和需求
- 优化整体结构和组织

## 优化提示词模板

### 基础优化模板
```
请优化以下提示词，使其更加[优化方向]。保持原始意图不变，但提高其质量和效果。

原始提示词：
[原始提示词]

优化要求：
1. 提高清晰度和具体性
2. 保留以下关键词：[关键词列表]
3. 优化后的提示词长度应在[最小长度]-[最大长度]之间
4. 使用[语言风格]的表达方式
```

### 多维度优化模板
```
请从多个维度优化以下提示词，并提供3个不同版本的优化结果。

原始提示词：
[原始提示词]

优化维度：
1. 清晰度和具体性
2. 创造性和多样性
3. 专业性和技术深度

对于每个优化版本，请说明其优化思路和预期效果。
```

## 前端界面设计

### 优化界面元素
1. **输入区域**：用户输入原始提示词的文本框
2. **参数控制**：优化参数的选择器和滑块
3. **优化按钮**：触发优化过程的按钮
4. **结果展示**：展示优化结果的区域
5. **操作按钮**：接受、修改、继续优化等操作按钮
6. **历史记录**：显示优化历史的面板

### 交互流程
1. 用户在输入区域输入原始提示词
2. 用户调整优化参数
3. 用户点击优化按钮
4. 系统显示优化中的动画效果
5. 系统展示优化结果
6. 用户可以接受、修改或继续优化
7. 系统记录优化历史

### 视觉反馈
- **优化中**：显示魔法能量聚集动画
- **优化完成**：展示结果呈现的光芒效果
- **操作反馈**：按钮点击和状态变化的视觉反馈
- **历史记录**：优化历史的时间线展示

## 后端实现

### API端点
- `POST /api/v1/prompts/enhance` - 优化提示词
- `GET /api/v1/prompts/enhance/history` - 获取优化历史
- `GET /api/v1/prompts/enhance/history/:id` - 获取特定优化记录
- `POST /api/v1/prompts/enhance/continue/:id` - 继续优化特定记录

### 请求参数
```json
{
  "original_prompt": "原始提示词内容",
  "optimization_params": {
    "model": "gpt-4",
    "strength": "medium",
    "direction": "clarity",
    "keywords": ["关键词1", "关键词2"],
    "temperature": 0.7,
    "max_length": 500,
    "format": "markdown",
    "style": "technical"
  }
}
```

### 响应格式
```json
{
  "success": true,
  "data": {
    "id": "优化记录ID",
    "original_prompt": "原始提示词内容",
    "enhanced_prompt": "优化后的提示词内容",
    "optimization_params": {
      "model": "gpt-4",
      "strength": "medium",
      "direction": "clarity",
      "keywords": ["关键词1", "关键词2"],
      "temperature": 0.7,
      "max_length": 500,
      "format": "markdown",
      "style": "technical"
    },
    "metrics": {
      "clarity": 8.5,
      "creativity": 7.2,
      "specificity": 9.0,
      "effectiveness": 8.8
    },
    "created_at": "2023-03-07T12:00:00Z"
  }
}
```

## 大模型API集成

### OpenAI API集成
```javascript
async function enhancePromptWithOpenAI(originalPrompt, params) {
  const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY,
  });

  const systemPrompt = generateSystemPrompt(params);
  
  const response = await openai.chat.completions.create({
    model: params.model || "gpt-4",
    messages: [
      { role: "system", content: systemPrompt },
      { role: "user", content: originalPrompt }
    ],
    temperature: params.temperature || 0.7,
    max_tokens: calculateMaxTokens(params.max_length),
  });

  return response.choices[0].message.content;
}
```

### Claude API集成
```javascript
async function enhancePromptWithClaude(originalPrompt, params) {
  const anthropic = new Anthropic({
    apiKey: process.env.CLAUDE_API_KEY,
  });
  
  const systemPrompt = generateSystemPrompt(params);
  
  const response = await anthropic.messages.create({
    model: params.model || "claude-2",
    system: systemPrompt,
    messages: [
      { role: "user", content: originalPrompt }
    ],
    temperature: params.temperature || 0.7,
    max_tokens: calculateMaxTokens(params.max_length),
  });

  return response.content[0].text;
}
```

## 优化质量评估

### 评估维度
1. **清晰度**：提示词的明确性和无歧义性
2. **具体性**：提示词的详细程度和精确性
3. **创造性**：提示词的创新性和独特性
4. **相关性**：提示词与用户意图的匹配度
5. **有效性**：提示词获得良好AI回复的可能性

### 评估方法
1. **模型评估**：使用大模型对优化结果进行评分
2. **用户反馈**：收集用户对优化结果的评价
3. **结果比较**：比较原始提示词和优化后提示词的AI回复质量

### 评估实现
```javascript
async function evaluatePromptQuality(prompt, params) {
  const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY,
  });

  const evaluationPrompt = `
    请评估以下提示词的质量，从1到10分进行打分，并提供简短理由：
    
    提示词：
    ${prompt}
    
    请从以下维度进行评分：
    1. 清晰度：提示词的明确性和无歧义性
    2. 具体性：提示词的详细程度和精确性
    3. 创造性：提示词的创新性和独特性
    4. 相关性：提示词与用户意图的匹配度
    5. 有效性：提示词获得良好AI回复的可能性
    
    请以JSON格式返回评分结果。
  `;
  
  const response = await openai.chat.completions.create({
    model: "gpt-4",
    messages: [
      { role: "user", content: evaluationPrompt }
    ],
    temperature: 0.3,
    response_format: { type: "json_object" }
  });

  return JSON.parse(response.choices[0].message.content);
}
```

## 用户体验优化

### 加载动画
- **阶段1**：显示居中的旋转指示器（2秒）
- **阶段2**：转变为带有粒子效果的脉动魔法球（2秒）
- **阶段3**：显示"正在优化您的提示..."并带有动态省略号（1.5秒）

### 结果展示
- **淡入效果**：优化结果以淡入方式显示
- **高亮差异**：突出显示原始提示词和优化后提示词的差异
- **分段展示**：将长提示词分段展示，提高可读性

### 用户反馈
- **满意度评分**：用户可以对优化结果进行评分
- **反馈评论**：用户可以提供文字反馈
- **改进建议**：系统根据用户反馈提供进一步优化建议

## 最佳实践

### 提示词优化技巧
1. 保持原始意图不变，只改进表达方式
2. 添加具体的细节和示例，避免模糊表述
3. 使用明确的指令和要求，避免开放式问题
4. 考虑AI模型的特性和限制，调整优化策略
5. 保持提示词的简洁和重点，避免过长或冗余

### 常见问题与解决方案
1. **优化结果偏离原意**
   - 解决方案：增加关键词保留功能，降低优化强度

2. **优化结果过于冗长**
   - 解决方案：设置最大长度限制，增加简洁性优化选项

3. **优化结果缺乏创造性**
   - 解决方案：增加温度参数，选择创造性优化方向

4. **优化速度过慢**
   - 解决方案：实现缓存机制，预先计算常见优化模式

## 未来扩展计划

### 功能扩展
1. **多语言支持**：支持多种语言的提示词优化
2. **领域特化优化**：针对特定领域（如编程、写作、营销）的优化模式
3. **批量优化**：支持多个提示词的批量优化
4. **提示词模板库**：提供预设的提示词模板和优化示例

### 技术改进
1. **本地模型支持**：支持本地部署的小型模型进行优化
2. **优化算法改进**：开发更高效的优化算法和策略
3. **实时协作**：支持多用户实时协作优化提示词
4. **API扩展**：支持更多大模型API的集成

## 实现计划

### 第一阶段：基础功能实现（1周）
1. **前端组件开发**
   - 创建`PromptEnhancement`组件
   - 实现输入区域和参数控制
   - 实现优化按钮和基本动画
   - 实现结果展示区域

2. **API集成**
   - 集成优化API端点
   - 实现错误处理和加载状态
   - 测试API响应处理

### 第二阶段：高级功能实现（1周）
1. **动画效果**
   - 实现优化中的魔法动画
   - 实现结果展示的淡入效果
   - 实现操作按钮的交互动画

2. **历史记录**
   - 实现优化历史记录展示
   - 实现历史记录的筛选和排序
   - 实现从历史记录中恢复优化

3. **用户反馈**
   - 实现满意度评分功能
   - 实现反馈评论功能
   - 实现改进建议功能

### 第三阶段：测试和优化（持续进行）
1. **单元测试**
   - 为所有组件编写测试用例
   - 测试各种参数组合
   - 测试错误处理和边缘情况

2. **用户体验优化**
   - 优化加载时间和响应速度
   - 改进视觉反馈和动画效果
   - 增强可访问性和易用性

3. **性能优化**
   - 实现缓存机制
   - 优化API请求频率
   - 减少不必要的重渲染

## 当前开发任务

1. **创建`PromptEnhancement`组件**
   - 负责人：我们两人
   - 状态：即将开始
   - 预计完成时间：3天
   - 详细任务：
     - 创建组件基本结构
     - 实现输入区域和参数控制
     - 实现优化按钮
     - 实现基本样式和布局

2. **实现优化动画**
   - 负责人：我们两人
   - 状态：计划中
   - 预计开始时间：`PromptEnhancement`组件完成后
   - 详细任务：
     - 实现优化中的魔法动画
     - 实现结果展示的淡入效果
     - 实现操作按钮的交互动画

3. **集成优化API**
   - 负责人：我们两人
   - 状态：计划中
   - 预计开始时间：动画实现完成后
   - 详细任务：
     - 集成优化API端点
     - 实现错误处理和加载状态
     - 测试API响应处理

## PromptImage功能测试指南

### 功能概述
PromptImage功能允许用户在AI平台输入框中输入"/"后显示提示词下拉菜单，并选择插入提示词。这是一个关键的快捷输入功能，能够显著提升用户使用AI平台的效率。

### 测试要点

1. **触发机制**：
   - 在输入框中输入"/"应触发下拉菜单
   - 菜单应显示在输入框下方的适当位置

2. **搜索功能**：
   - 输入"/"后跟随关键词应筛选相关提示词
   - 结果应按"收藏>高频使用>低频使用"排序

3. **选择与插入**：
   - 可通过键盘上下箭头导航菜单项
   - 按Enter键或点击选择提示词
   - 选择后应将提示词插入到输入框，替换"/"

4. **界面交互**：
   - 下拉菜单应有魔法主题风格
   - 悬停效果和动画应流畅
   - 点击外部应关闭下拉菜单

### 常见问题与解决方案

#### 问题1: 下拉菜单不显示
**原因**：输入框选择器不匹配或事件监听器未添加
**解决方案**：
```javascript
// 使用多种选择器查找输入框
let input = document.querySelector('textarea[data-id="root"]');
if (!input) input = document.querySelector('.claude-input textarea');
if (!input) input = document.querySelector('.ql-editor');
if (!input) {
  const textareas = Array.from(document.querySelectorAll('textarea'));
  input = textareas.find(el => el.offsetWidth > 200 && el.offsetHeight > 30);
}
console.log('找到输入框:', !!input, input);
```

#### 问题2: 选择提示词后不插入或跳转页面
**原因**：事件处理不正确或默认行为未阻止
**解决方案**：
```javascript
// 改进的点击事件处理
item.addEventListener('click', function(e) {
  // 阻止默认行为和事件冒泡
  e.preventDefault();
  e.stopPropagation();
  
  // 直接操作输入框值
  inputField.value = inputField.value.replace('/', this.textContent);
  
  // 触发input事件，确保平台能够检测到输入变化
  const inputEvent = new Event('input', { bubbles: true });
  inputField.dispatchEvent(inputEvent);
  
  // 移除下拉菜单并聚焦回输入框
  if (document.body.contains(dropdown)) {
    document.body.removeChild(dropdown);
  }
  inputField.focus();
  
  return false;
});
```

#### 问题3: 多次触发事件监听
**原因**：事件监听器重复添加
**解决方案**：
```javascript
// 使用标记防止重复添加监听器
if (!inputField._hasPromptImageListener) {
  inputField.addEventListener('input', handleInput);
  inputField._hasPromptImageListener = true;
  console.log('事件监听器已添加');
}
```

### 人工测试步骤

1. **准备工作**：
   - 确保已添加必要的日志记录
   - 准备测试用的提示词数据

2. **基本功能测试**：
   - 在输入框中输入"/"，验证下拉菜单是否显示
   - 输入"/测试"，验证搜索功能是否正常
   - 使用键盘上下箭头导航，验证选择高亮是否正常
   - 按Enter键选择提示词，验证是否正确插入

3. **边缘情况测试**：
   - 测试在输入框中间输入"/"的情况
   - 测试快速连续输入多个"/"的情况
   - 测试在不同AI平台上的表现

4. **调试技巧**：
   - 使用`console.log`跟踪关键操作
   - 在浏览器控制台中直接调用测试函数
   ```javascript
   // 测试函数示例
   window.testPromptImage = function() {
     const input = document.querySelector('textarea');
     if (input) {
       input.value += '/';
       input.dispatchEvent(new Event('input', { bubbles: true }));
     }
   };
   ```

通过以上测试指南，可以确保PromptImage功能在各种环境中正常工作，提供流畅的用户体验。

最后更新时间：2023年11月15日 