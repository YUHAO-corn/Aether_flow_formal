# AetherFlow 开发环境与部署指南

## 概述
本文档整合了AetherFlow项目的开发环境搭建和部署指南的核心内容，作为我们两人协作开发的参考指南。

## 环境配置协作方式

当开发环境缺少必要工具或配置时，我们采用以下协作方式：

1. **明确识别问题**：确定缺少什么工具或配置（如Node.js、npm等）
2. **提供安装指令**：开发人员提供详细的安装步骤
3. **执行安装**：由具有适当权限的团队成员执行安装操作
4. **验证安装**：确认工具已正确安装并可用（如运行`node --version`和`npm --version`）
5. **继续开发任务**：使用新安装的工具完成原定任务

这种方式确保我们不会因环境问题而降低开发质量，而是直接解决问题后继续高效开发。

## 开发环境要求

- Node.js: v14.0.0或更高版本（推荐使用LTS版本）
- npm: v6.0.0或更高版本
- Git: 最新稳定版
- 现代浏览器（Chrome、Firefox、Edge等）
- 代码编辑器（推荐VS Code）

## 开发环境搭建

### 系统要求
- Node.js 16.x 或更高版本
- npm 8.x 或更高版本
- MongoDB 5.0 或更高版本
- Git

### 克隆仓库
```bash
git clone https://github.com/yourusername/AetherFlow_v1.git
cd AetherFlow_v1
```

### 后端环境设置

1. **安装依赖**
```bash
cd AetherFlow_backend
npm install
```

2. **环境变量配置**
创建 `.env` 文件，包含以下内容：
```
# 服务器配置
PORT=3000
NODE_ENV=development

# 数据库配置
MONGODB_URI=mongodb://localhost:27017/aetherflow
MONGODB_TEST_URI=mongodb://localhost:27017/aetherflow_test

# JWT配置
JWT_SECRET=your_jwt_secret_key
JWT_EXPIRES_IN=7d
JWT_REFRESH_EXPIRES_IN=30d

# 大模型API配置
OPENAI_API_KEY=your_openai_api_key
CLAUDE_API_KEY=your_claude_api_key

# 日志配置
LOG_LEVEL=debug
```

3. **启动开发服务器**
```bash
npm run dev
```

4. **运行测试**
```bash
npm test
```

### 网页端前端环境设置

1. **安装依赖**
```bash
cd AetherFlow_web_front
npm install
```

2. **环境变量配置**
创建 `.env` 文件，包含以下内容：
```
VITE_API_BASE_URL=http://localhost:3000/api/v1
VITE_ENV=development
```

3. **启动开发服务器**
```bash
npm run dev
```

### 浏览器插件前端环境设置

1. **安装依赖**
```bash
cd AetherFlow_plugin_front
npm install
```

2. **环境变量配置**
创建 `.env` 文件，包含以下内容：
```
VITE_API_BASE_URL=http://localhost:3000/api/v1
VITE_ENV=development
```

3. **构建插件**
```bash
npm run build
```

4. **在浏览器中加载插件**
   - 打开Chrome浏览器，进入扩展管理页面 (chrome://extensions/)
   - 启用"开发者模式"
   - 点击"加载已解压的扩展程序"
   - 选择 `AetherFlow_plugin_front/dist` 目录

## 开发工作流

### 分支管理
1. 主分支：
   - `main`：稳定版本，用于生产环境
   - `develop`：开发版本，用于集成测试

2. 功能分支：
   - 命名格式：`feature/功能名称`
   - 从`develop`分支创建
   - 完成后合并回`develop`分支

### 开发流程
1. 从`develop`分支创建新的功能分支
```bash
git checkout develop
git pull
git checkout -b feature/your-feature-name
```

2. 在功能分支上进行开发

3. 提交代码
```bash
git add .
git commit -m "feat: 添加新功能"
```

4. 将功能分支推送到远程仓库
```bash
git push origin feature/your-feature-name
```

5. 创建Pull Request，将功能分支合并到`develop`分支

6. 代码审查通过后，合并Pull Request

## 部署指南

### 开发环境部署

#### 使用Docker Compose
1. **构建镜像**
```bash
docker-compose build
```

2. **启动服务**
```bash
docker-compose up -d
```

3. **查看日志**
```bash
docker-compose logs -f
```

4. **停止服务**
```bash
docker-compose down
```

### 生产环境部署

#### 准备工作
1. 确保服务器已安装Docker和Docker Compose
2. 准备生产环境的环境变量文件

#### 部署步骤
1. **克隆仓库**
```bash
git clone https://github.com/yourusername/AetherFlow_v1.git
cd AetherFlow_v1
```

2. **切换到生产分支**
```bash
git checkout main
```

3. **创建生产环境配置文件**
创建 `.env.production` 文件，包含生产环境的配置

4. **构建生产镜像**
```bash
docker-compose -f docker-compose.prod.yml build
```

5. **启动生产服务**
```bash
docker-compose -f docker-compose.prod.yml up -d
```

6. **配置Nginx反向代理**
创建Nginx配置文件，将请求转发到Docker容器

7. **配置SSL证书**
使用Let's Encrypt获取SSL证书，并配置HTTPS

### 持续集成/持续部署 (CI/CD)

#### GitHub Actions配置
在 `.github/workflows` 目录下创建工作流配置文件：

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'
      - name: Install dependencies
        run: |
          cd AetherFlow_backend
          npm install
      - name: Run tests
        run: |
          cd AetherFlow_backend
          npm test

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - uses: actions/checkout@v2
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'
      - name: Build backend
        run: |
          cd AetherFlow_backend
          npm install
          npm run build
      - name: Build web frontend
        run: |
          cd AetherFlow_web_front
          npm install
          npm run build
      - name: Build plugin frontend
        run: |
          cd AetherFlow_plugin_front
          npm install
          npm run build
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: build-artifacts
          path: |
            AetherFlow_backend/dist
            AetherFlow_web_front/dist
            AetherFlow_plugin_front/dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v2
        with:
          name: build-artifacts
      - name: Deploy to production
        # 部署到生产服务器的脚本
        run: echo "部署到生产环境"
```

## 监控与维护

### 日志管理
- 使用Winston记录应用日志
- 使用ELK Stack (Elasticsearch, Logstash, Kibana) 进行日志聚合和分析

### 性能监控
- 使用Prometheus收集性能指标
- 使用Grafana创建监控仪表盘

### 数据库备份
- 设置MongoDB定时备份
- 将备份文件存储在安全的位置

### 故障恢复
1. 准备回滚脚本
2. 制定故障恢复流程
3. 定期进行恢复演练

## 安全最佳实践

### 应用安全
1. 定期更新依赖包
2. 使用Helmet设置安全相关的HTTP头
3. 实现速率限制防止暴力攻击
4. 使用参数化查询防止注入攻击

### 服务器安全
1. 只开放必要的端口
2. 使用防火墙限制访问
3. 定期更新服务器软件
4. 设置SSH密钥认证

### 数据安全
1. 加密敏感数据
2. 实现定期数据备份
3. 设置适当的访问控制

## 常见问题与解决方案

### 开发环境问题
1. **MongoDB连接失败**
   - 检查MongoDB服务是否启动
   - 验证连接字符串是否正确
   - 确认网络连接是否正常

2. **Node.js版本不兼容**
   - 使用nvm安装正确的Node.js版本
   - 更新package.json中的引擎要求

### 部署问题
1. **Docker容器无法启动**
   - 检查Docker日志
   - 验证环境变量是否正确
   - 确认端口是否被占用

2. **API请求失败**
   - 检查网络连接
   - 验证API路径是否正确
   - 确认认证信息是否有效

### npm权限问题

如果遇到npm权限错误，可以尝试以下方法：

1. 在Windows上，以管理员身份运行命令提示符或PowerShell
2. 在Linux/Mac上，使用sudo或修改npm默认目录权限

### 执行策略限制

在Windows PowerShell中，如果遇到执行策略限制，可以通过以下命令临时更改策略：

```powershell
Set-ExecutionPolicy RemoteSigned -Scope Process
```

### 依赖安装失败

如果依赖安装失败，可以尝试清除npm缓存：

```bash
npm cache clean --force
```

然后重新安装依赖。

最后更新时间：2023年3月7日 