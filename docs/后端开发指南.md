# AetherFlow 后端开发指南

## 概述
本文档整合了AetherFlow项目的后端架构设计和API文档的核心内容，作为我们两人协作开发的参考指南。

## 技术栈

- **编程语言**：Node.js
- **Web框架**：Express.js
- **数据库**：MongoDB
- **认证**：JWT (JSON Web Token)
- **API文档**：Swagger/OpenAPI
- **测试框架**：Jest
- **ORM/ODM**：Mongoose
- **日志**：Winston
- **部署**：Docker + Docker Compose

## 系统架构

### 整体架构
```
                                  ┌─────────────────┐
                                  │   负载均衡器    │
                                  └────────┬────────┘
                                           │
                 ┌───────────────┬─────────┴──────────┬───────────────┐
                 │               │                    │               │
        ┌────────▼─────────┐    ┌▼───────────────┐   ┌▼──────────────┐
        │  API服务实例 1   │    │  API服务实例 2  │   │  API服务实例 n │
        └────────┬─────────┘    └┬───────────────┘   └┬──────────────┘
                 │               │                    │
                 └───────────────┼────────────────────┘
                                 │
                 ┌───────────────┼───────────────────┐
                 │               │                   │
        ┌────────▼─────────┐    ┌▼──────────────┐   ┌▼──────────────┐
        │    MongoDB       │    │    Redis      │   │  文件存储     │
        │  (主数据存储)     │    │  (缓存/队列)  │   │ (用户上传文件) │
        └──────────────────┘    └───────────────┘   └───────────────┘
```

### 服务层次结构
1. **API层**：处理HTTP请求和响应
2. **业务逻辑层**：实现核心业务逻辑
3. **数据访问层**：与数据库交互
4. **外部服务集成层**：与大模型API等外部服务交互

### 模块划分
1. **认证模块**：用户注册、登录、权限控制
2. **Prompt管理模块**：Prompt的CRUD操作
3. **标签管理模块**：标签的CRUD操作
4. **Prompt优化模块**：调用大模型API优化Prompt
5. **数据分析模块**：生成仪表盘数据
6. **沙盘调试模块**：与大模型API交互进行对话测试

## 数据模型

### 用户模型 (User)
```javascript
{
  _id: ObjectId,
  username: String,
  email: String,
  password: String (hashed),
  created_at: Date,
  updated_at: Date,
  last_login: Date,
  settings: {
    theme: String,
    language: String,
    notifications: Boolean
  },
  role: String (enum: ['user', 'admin'])
}
```

### 提示词模型 (Prompt)
```javascript
{
  _id: ObjectId,
  user_id: ObjectId (ref: User),
  content: String,
  response: String,
  platform: String,
  url: String,
  created_at: Date,
  updated_at: Date,
  tags: [ObjectId] (ref: Tag),
  favorite: Boolean,
  usage_count: Number,
  metrics: {
    clarity: Number,
    specificity: Number,
    creativity: Number,
    relevance: Number,
    effectiveness: Number
  }
}
```

### 标签模型 (Tag)
```javascript
{
  _id: ObjectId,
  user_id: ObjectId (ref: User),
  name: String,
  color: String,
  created_at: Date,
  updated_at: Date
}
```

### 对话历史模型 (Conversation)
```javascript
{
  _id: ObjectId,
  user_id: ObjectId (ref: User),
  model: String,
  created_at: Date,
  updated_at: Date,
  messages: [
    {
      role: String (enum: ['user', 'assistant']),
      content: String,
      timestamp: Date
    }
  ]
}
```

### 用户活动日志模型 (ActivityLog)
```javascript
{
  _id: ObjectId,
  user_id: ObjectId (ref: User),
  action: String,
  entity_type: String,
  entity_id: ObjectId,
  timestamp: Date,
  details: Object
}
```

## 核心API端点

### 认证API
- `POST /api/v1/auth/register` - 用户注册
- `POST /api/v1/auth/login` - 用户登录
- `POST /api/v1/auth/refresh` - 刷新token
- `POST /api/v1/auth/logout` - 用户登出
- `GET /api/v1/auth/me` - 获取当前用户信息

### 提示词管理API
- `GET /api/v1/prompts` - 获取提示词列表
- `GET /api/v1/prompts/:id` - 获取单个提示词
- `POST /api/v1/prompts` - 创建提示词
- `PUT /api/v1/prompts/:id` - 更新提示词
- `DELETE /api/v1/prompts/:id` - 删除提示词
- `POST /api/v1/prompts/:id/favorite` - 收藏/取消收藏提示词
- `POST /api/v1/prompts/:id/usage` - 增加提示词使用次数

### 标签管理API
- `GET /api/v1/tags` - 获取标签列表
- `GET /api/v1/tags/:id` - 获取单个标签
- `POST /api/v1/tags` - 创建标签
- `PUT /api/v1/tags/:id` - 更新标签
- `DELETE /api/v1/tags/:id` - 删除标签

### 提示词优化API
- `POST /api/v1/prompts/enhance` - 优化提示词

### 数据分析API
- `GET /api/v1/dashboard` - 获取仪表盘数据
- `GET /api/v1/dashboard/tag-cloud` - 获取标签云数据
- `GET /api/v1/dashboard/quality-metrics` - 获取质量指标数据
- `GET /api/v1/dashboard/usage-heatmap` - 获取使用热力图数据

### 沙盘调试API
- `POST /api/v1/sandbox/chat` - 发送消息到大模型
- `GET /api/v1/sandbox/conversations` - 获取对话历史列表
- `GET /api/v1/sandbox/conversations/:id` - 获取单个对话历史
- `DELETE /api/v1/sandbox/conversations/:id` - 删除对话历史

## API响应格式

所有API响应遵循以下统一格式：
```json
{
  "success": true/false,
  "data": {}, // 成功时返回的数据
  "error": {  // 失败时返回的错误信息
    "code": "ERROR_CODE",
    "message": "错误描述"
  },
  "meta": {   // 元数据，如分页信息
    "page": 1,
    "limit": 10,
    "total": 100
  }
}
```

## 错误处理

### 错误码
- `AUTH_FAILED`: 认证失败
- `INVALID_PARAM`: 参数无效
- `RESOURCE_NOT_FOUND`: 资源未找到
- `RATE_LIMITED`: 请求频率限制
- `SERVER_ERROR`: 服务器内部错误

### HTTP状态码
- 200: 请求成功
- 201: 资源创建成功
- 400: 请求参数错误
- 401: 未授权
- 403: 权限不足
- 404: 资源不存在
- 429: 请求过于频繁
- 500: 服务器内部错误

## 安全措施

1. **认证中间件**：验证JWT token
2. **授权中间件**：检查用户权限
3. **输入验证**：使用Joi或express-validator验证请求数据
4. **速率限制**：使用express-rate-limit防止滥用
5. **CORS配置**：限制跨域请求
6. **Helmet**：设置安全相关的HTTP头

## 缓存策略

### Redis缓存
1. **用户会话缓存**：存储用户会话信息
2. **热门提示词缓存**：缓存频繁访问的提示词
3. **仪表盘数据缓存**：缓存计算密集型的仪表盘数据

### 缓存失效策略
1. **时间过期**：设置适当的TTL
2. **手动失效**：数据更新时主动使缓存失效
3. **LRU策略**：当缓存空间不足时，优先移除最近最少使用的项

## 提示词优化实现

### 优化流程
1. 接收用户提交的原始提示词
2. 根据用户选择的优化模型和参数构建请求
3. 调用大模型API进行优化
4. 处理API响应，提取优化后的提示词
5. 保存优化历史记录
6. 返回优化结果给客户端

### 优化参数
- `model`: 使用的大模型（如"gpt-4"、"claude-2"等）
- `temperature`: 控制输出的随机性（0.0-1.0）
- `max_tokens`: 生成的最大token数
- `optimization_type`: 优化类型（如"clarity"、"creativity"等）

## 部署考虑

### 开发环境
- 本地Node.js环境
- 本地MongoDB实例或MongoDB Atlas
- 环境变量配置（.env文件）

### 生产环境
- Docker容器化部署
- 负载均衡配置
- 数据库备份策略
- 监控和日志收集
- CI/CD流程

## 开发与测试流程

### 开发流程
1. 根据需求创建新分支
2. 实现功能并编写测试
3. 本地测试通过后提交代码
4. 创建Pull Request并进行代码审查
5. 合并到主分支

### 测试策略
1. **单元测试**：测试独立功能单元
2. **集成测试**：测试模块间交互
3. **API测试**：测试API端点
4. **性能测试**：测试系统在负载下的表现

## 后续开发计划

1. **性能优化**：
   - 实现更高效的数据库查询
   - 优化缓存策略
   - 实现数据库索引优化

2. **功能扩展**：
   - 实现更多的提示词优化选项
   - 添加用户反馈和评分系统
   - 实现提示词分享功能

3. **安全增强**：
   - 实现双因素认证
   - 增强密码策略
   - 实现API密钥轮换机制

最后更新时间：2023年3月7日 