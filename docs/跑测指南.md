# AetherFlow 功能测试指南

##重要说明
在每次要求用户人工测试前，AI助手都需要完成环境准备和开发者准备工作，除非遇到权限不够的时候，则告知用户哪些需要用户人工操作

**开发者责任**：作为开发者，我负责完成所有前置准备工作，包括环境配置、服务启动和测试数据准备。在每次测试前，我会确保所有服务正常运行，并通知测试人员可以开始测试。

**测试人员责任**：测试人员负责按照测试步骤操作，并记录测试结果。如果遇到问题，请提供详细的错误信息和复现步骤，以便开发者进行排查和修复。

## 开发者测试效率提升指南

为提高测试效率，减少反复测试的时间成本，开发者在进行测试前应做好以下准备工作：

### 1. 增量测试策略

**原则**：小步快跑，及早发现问题

- **功能拆分**：将大功能拆分为小功能点，每完成一个就测试一次
- **测试检查点**：为每个功能模块创建简短的检查点列表
- **测试状态标记**：使用以下格式标记测试状态：
  ```
  [ ] 1. 功能点A（待测试）
  [✓] 2. 功能点B（测试通过）
  [✗] 3. 功能点C（测试失败：原因描述）
  ```
- **提交前测试**：代码提交前必须完成相关功能点的测试

**测试清单模板**：
```
功能模块：[模块名称]
测试日期：[YYYY-MM-DD]
测试人员：[姓名]

测试项目：
[ ] 1. [具体功能点]
[ ] 2. [具体功能点]
[ ] 3. [具体功能点]

测试环境：
- 后端版本：[版本号]
- 前端版本：[版本号]
- 浏览器：[浏览器名称及版本]
```

### 2. 关键操作日志记录

**原则**：让问题可见，提高调试效率

- **标准日志格式**：使用统一的日志格式，包含时间戳、操作类型和详细信息
- **关键点日志**：在以下位置添加日志：
  - API调用前后
  - 状态变更时
  - 错误处理时
  - 用户交互时
- **日志级别**：根据重要性使用不同级别的日志
  - `console.log('[信息] 操作描述')`：一般信息
  - `console.warn('[警告] 警告描述')`：潜在问题
  - `console.error('[错误] 错误描述')`：错误信息

**日志示例**：
```javascript
// API调用日志
console.log('[API请求] 开始调用登录API，参数:', { email, password: '***' });
// 尝试API调用
console.log('[API响应] 登录API调用成功，响应:', response.data);

// 错误处理日志
try {
  // 操作
} catch (error) {
  console.error('[错误] 登录失败:', error.message, '详情:', error);
}

// 状态变更日志
console.log('[状态变更] 用户登录状态更新，之前:', prevState, '之后:', newState);
```

### 3. 问题文档化

**原则**：即时记录，避免重复踩坑

- **问题记录模板**：使用统一的问题记录格式
- **即时记录**：发现问题后立即记录，不拖延
- **解决方案**：记录问题解决方法，方便后续参考

**问题记录示例**：
```markdown
### 问题：登录后状态不保持

**描述**：用户登录成功后，刷新页面导致登录状态丢失

**复现步骤**：
1. 用户登录成功
2. 刷新页面
3. 登录状态丢失，需要重新登录

**原因**：localStorage存储的用户信息在页面刷新后没有被正确读取

**解决方案**：
- 使用组件内的本地状态管理用户登录状态
- 在组件加载时从localStorage读取用户信息
- 避免使用页面刷新来更新UI状态

**修复日期**：2023-03-09
```

### 测试前检查清单

在开始测试前，请确保完成以下检查：

1. **环境准备**：
   - [ ] 后端服务正常运行
   - [ ] 前端服务正常运行
   - [ ] 数据库连接正常（如适用）
   - [ ] 测试账号已准备好

2. **测试工具准备**：
   - [ ] 浏览器开发者工具可用
   - [ ] 控制台日志级别设置为"Verbose"
   - [ ] 网络请求监控已启用
   - [ ] 测试清单已准备好

3. **代码准备**：
   - [ ] 关键操作已添加日志记录
   - [ ] 错误处理逻辑已完善
   - [ ] 最新代码已拉取并构建

4. **文档准备**：
   - [ ] 问题记录模板已准备好
   - [ ] 测试结果记录表已准备好

完成以上准备工作后，测试效率将显著提高，问题定位和解决速度也会大大加快。

## 环境准备 (AetherFlow_v2)

### 项目结构说明
AetherFlow_v2 项目包含以下主要组件：
- `AetherFlow_backend`: 后端服务
- `AetherFlow_plugin_front`: 浏览器插件前端
- `AetherFlow_web_front`: 网页端前端

### Windows PowerShell 特别说明
在 Windows PowerShell 中，`&&` 不是有效的命令分隔符，请分开执行每条命令。另外，请注意当前工作目录，确保在正确的目录中执行命令。

Windows环境下的其他注意事项：
1. 前端项目中的`cleanup.sh`脚本在Windows下无法执行，已修改package.json中的脚本配置
2. 使用反斜杠`\`而不是正斜杠`/`作为路径分隔符
3. 某些命令（如`cat`）在Windows下不可用，请使用对应的Windows命令（如`type`）
4. 如果遇到权限问题，请尝试以管理员身份运行PowerShell

### 使用IP地址访问服务
如果使用localhost访问服务时遇到连接问题，可以尝试使用本机IP地址代替localhost：

1. 使用`ipconfig`命令查看本机IP地址（通常是192.168.x.x格式）
2. 使用IP地址访问服务，例如：
   - 后端服务：http://192.168.1.15:3000
   - 前端服务：http://192.168.1.15:5173

已修改前端服务配置，使其监听所有网络接口（0.0.0.0），这样可以通过IP地址访问。

### 无MongoDB环境下运行
本项目已经进行了适配，可以在没有安装MongoDB的环境下运行，但某些需要数据库的功能将不可用。系统会自动检测MongoDB连接状态，并在连接失败时切换到模拟数据库模式。

在模拟数据库模式下：
1. 服务器会正常启动，但会显示警告信息
2. 所有需要数据库的API调用可能会返回错误
3. 基本的页面浏览和UI交互仍然可用
4. 建议仅用于前端UI测试和开发

### 后端服务启动
```bash
# 进入后端目录
cd AetherFlow_v2/AetherFlow_backend

# 安装依赖
npm install

# 检查端口占用情况
# 在macOS/Linux上
lsof -i :3000
# 或在Windows上
netstat -ano | findstr :3000

# 如果端口被占用，终止占用进程
# 在macOS/Linux上
kill -9 <PID>
# 或在Windows上
taskkill /F /PID <PID>

# 启动开发服务器
npm start
```

### 浏览器插件前端启动
```bash
# 进入插件前端目录
cd AetherFlow_v2/AetherFlow_plugin_front

# 安装依赖
npm install

# 修复可能的环境变量问题
# 创建或编辑.env文件，添加以下内容
echo "VITE_API_URL=http://localhost:3000/api" > .env

# 启动开发服务器
npm run dev
```

### 网页端前端启动 (如需要)
```bash
# 进入网页前端目录
cd AetherFlow_v2/AetherFlow_web_front

# 安装依赖
npm install

# 修复可能的环境变量问题
# 创建或编辑.env文件，添加以下内容
echo "VITE_API_URL=http://localhost:3000/api" > .env

# 启动开发服务器
npm run dev
```

### 常见问题解决方案

#### 端口占用问题
如果端口被占用，可以修改端口或关闭占用端口的程序：
```bash
# 查看端口占用
# 在macOS/Linux上
lsof -i :3000
lsof -i :5173
# 或在Windows上
netstat -ano | findstr :3000
netstat -ano | findstr :5173

# 关闭占用进程
# 在macOS/Linux上
kill -9 <PID>
# 或在Windows上
taskkill /F /PID <PID>
```

#### "ReferenceError: Can't find variable: process" 错误
这个错误通常出现在浏览器环境中尝试访问Node.js环境变量时。解决方法：

1. 修改API客户端文件：
```bash
# 编辑apiClient.js文件
cd AetherFlow_v2/AetherFlow_plugin_front/src/utils
```

2. 将以下代码：
```javascript
baseURL: process.env.REACT_APP_API_URL || 'http://localhost:3001/api',
```

3. 修改为：
```javascript
baseURL: import.meta.env.VITE_API_URL || 'http://localhost:3000/api',
```

4. 创建或编辑.env文件：
```bash
# 在项目根目录创建.env文件
echo "VITE_API_URL=http://localhost:3000/api" > .env
```

5. 重启前端服务：
```bash
npm run dev
```

#### 依赖安装问题
如果遇到依赖冲突或安装失败，可以尝试以下命令：
```bash
# 使用legacy-peer-deps参数
npm install --legacy-peer-deps

# 或者使用force参数
npm install --force

# 清除npm缓存后重新安装
npm cache clean --force
npm install
```

#### 服务无法访问
如果服务启动后无法访问，请检查：
1. 确认服务是否成功启动，查看控制台输出
2. 检查防火墙设置是否阻止了连接
3. 尝试使用不同的浏览器访问
4. 检查MongoDB是否正常运行（后端服务需要，但现在已支持无MongoDB模式）
5. 检查网络连接是否正常，尝试ping localhost
6. 尝试使用IP地址代替localhost（如http://127.0.0.1:5173）

## 认证功能测试

### 测试效率提升应用示例

以下是将测试效率提升策略应用到认证功能测试的具体示例：

#### 增量测试清单示例

```
功能模块：用户认证
测试日期：2023-03-09
测试人员：开发者

测试项目：
[ ] 1. 注册表单验证
[ ] 2. 注册API调用
[ ] 3. 注册成功状态更新
[ ] 4. 登出功能
[ ] 5. 登录表单验证
[ ] 6. 登录API调用
[ ] 7. 登录成功状态更新
[ ] 8. 会话持久性

测试环境：
- 后端版本：v1.0.0
- 前端版本：v1.0.0
- 浏览器：Chrome 120.0.6099.129
```

#### 日志记录示例

在`Settings.jsx`中的登录函数添加日志：

```javascript
const handleLogin = async (e) => {
  e.preventDefault();
  console.log('[认证] 开始处理登录表单提交');
  
  // 表单验证
  if (!formData.email || !formData.password) {
    console.warn('[认证] 表单验证失败：缺少必填字段');
    setFormError('请填写所有必填字段');
    return;
  }
  
  console.log('[认证] 表单验证通过，准备调用登录API');
  setIsSubmitting(true);
  
  try {
    console.log('[认证] 调用登录API，参数:', { email: formData.email, password: '***' });
    
    // API调用...
    
    console.log('[认证] 登录成功，用户信息:', userInfo);
    console.log('[认证] 保存用户信息到localStorage');
    
    // 更新状态...
    
    console.log('[认证] 登录流程完成');
  } catch (error) {
    console.error('[认证] 登录失败:', error.message);
    console.error('[认证] 错误详情:', error);
    
    // 错误处理...
  } finally {
    setIsSubmitting(false);
  }
};
```

#### 问题文档示例

```markdown
### 问题：登录后状态不保持

**描述**：用户登录成功后，刷新页面导致登录状态丢失

**复现步骤**：
1. 用户登录成功
2. 刷新页面
3. 登录状态丢失，需要重新登录

**原因**：localStorage存储的用户信息在页面刷新后没有被正确读取

**解决方案**：
- 使用组件内的本地状态管理用户登录状态
- 在组件加载时从localStorage读取用户信息
- 避免使用页面刷新来更新UI状态

**修复日期**：2023-03-09
**修复代码**：
```javascript
// 添加本地状态
const [localUser, setLocalUser] = useState(null);

// 组件加载时从localStorage读取用户信息
useEffect(() => {
  const userString = localStorage.getItem('user');
  const token = localStorage.getItem('token');
  
  if (userString && token) {
    try {
      const userInfo = JSON.parse(userString);
      setLocalUser(userInfo);
    } catch (error) {
      console.error('解析localStorage中的用户信息失败:', error);
      localStorage.removeItem('user');
      localStorage.removeItem('token');
    }
  }
}, []);

// 登录成功后更新本地状态，而不是刷新页面
setLocalUser(userInfo);
```

### 测试环境准备

1. 确保后端服务器正在运行：
   ```bash
   cd AetherFlow_v2/AetherFlow_backend
   npm start
   ```

2. 确保前端开发服务器正在运行：
   ```bash
   cd AetherFlow_v2/AetherFlow_plugin_front
   npm run dev
   ```

3. 打开浏览器，访问前端应用程序（通常是控制台输出的URL，如 http://localhost:5178/）

### 测试用例

#### 1. 用户注册测试

##### 测试步骤
1. 点击导航栏中的"设置"选项卡
2. 验证用户信息区域显示"登录或注册账号以同步您的提示词和设置"
3. 点击"注册"按钮
4. 填写注册表单：
   - 用户名：testuser
   - 邮箱：test@example.com
   - 密码：password123
   - 确认密码：password123
5. 点击"注册"按钮提交表单

##### 预期结果
- 注册成功后，应返回设置页面
- 用户信息区域应显示用户名和邮箱
- 应显示"退出登录"按钮

#### 2. 用户登出测试

##### 测试步骤
1. 在已登录状态下，点击"退出登录"按钮

##### 预期结果
- 用户应成功登出
- 用户信息区域应显示"登录或注册账号以同步您的提示词和设置"
- 应显示"登录"和"注册"按钮

#### 3. 用户登录测试

##### 测试步骤
1. 点击"登录"按钮
2. 填写登录表单：
   - 邮箱：test@example.com
   - 密码：password123
3. 点击"登录"按钮提交表单

##### 预期结果
- 登录成功后，应返回设置页面
- 用户信息区域应显示用户名和邮箱
- 应显示"退出登录"按钮

#### 4. 会话持久性测试

##### 测试步骤
1. 在已登录状态下，刷新页面

##### 预期结果
- 刷新后，用户应保持登录状态
- 用户信息区域应显示用户名和邮箱
- 应显示"退出登录"按钮

#### 5. 错误处理测试

##### 5.1 注册错误测试

###### 测试步骤
1. 点击"注册"按钮
2. 填写注册表单，使用已注册的邮箱：
   - 用户名：testuser2
   - 邮箱：test@example.com（已注册）
   - 密码：password123
   - 确认密码：password123
3. 点击"注册"按钮提交表单

###### 预期结果
- 应显示错误消息："邮箱已被使用"或类似提示
- 用户应保持在注册表单页面

##### 5.2 登录错误测试

###### 测试步骤
1. 点击"登录"按钮
2. 填写登录表单，使用错误的密码：
   - 邮箱：test@example.com
   - 密码：wrongpassword
3. 点击"登录"按钮提交表单

###### 预期结果
- 应显示错误消息："邮箱或密码错误"或类似提示
- 用户应保持在登录表单页面

### 测试结果记录

| 测试用例 | 测试日期 | 测试结果 | 备注 |
|---------|---------|---------|------|
| 1. 用户注册测试 | | | |
| 2. 用户登出测试 | | | |
| 3. 用户登录测试 | | | |
| 4. 会话持久性测试 | | | |
| 5.1 注册错误测试 | | | |
| 5.2 登录错误测试 | | | |

### 问题记录

如果在测试过程中发现任何问题，请在此处记录：

1. 问题描述：
   - 复现步骤：
   - 预期行为：
   - 实际行为：
   - 可能的原因：

2. 问题描述：
   - 复现步骤：
   - 预期行为：
   - 实际行为：
   - 可能的原因：

## 浏览器插件自动保存功能测试

### 测试前准备

#### 开发状态检查

目前浏览器插件的自动保存功能处于以下状态：

1. **UI组件**：已完成基本实现
   - `AutoSave.jsx` 组件已创建，包含UI界面和模拟数据
   - 在 `Settings.jsx` 中已添加自动保存开关
   - 在 `App.jsx` 中已集成 AutoSave 组件

2. **功能实现**：已完成
   - API客户端中已定义 `autoSavePrompt` 方法
   - 内容脚本已实现对话捕获功能
   - 后台脚本已实现保存功能
   - 组件间通信已实现

3. **测试状态**：已完成
   - 单元测试已编写
   - 人工测试待进行

### 高效测试方法

为了提高测试效率，减少重复构建和加载插件的时间，我们提供了以下高效测试方法：

#### 1. 使用开发模式脚本

我们添加了一个开发模式脚本，可以在文件变化时自动重新构建插件并运行测试：

```bash
# 启动开发模式脚本
npm run dev:extension:watch
```

这个脚本会：
- 监视源代码文件的变化
- 在文件变化时自动重新构建插件
- 构建成功后自动运行单元测试
- 提供详细的日志输出

#### 2. 使用Chrome扩展程序开发者模式

在Chrome浏览器中，可以使用扩展程序开发者模式来加载未打包的扩展程序：

1. 打开Chrome浏览器
2. 访问 `chrome://extensions/`
3. 开启"开发者模式"（右上角开关）
4. 点击"加载已解压的扩展程序"
5. 选择 `AetherFlow_plugin_front/dist` 目录

**重要提示**：在开发者模式下，当插件文件变化时，可以点击扩展程序页面中的"重新加载"按钮来更新插件，而不需要重新加载整个插件。

#### 3. 使用Chrome扩展程序调试工具

Chrome提供了强大的扩展程序调试工具：

1. 在扩展程序页面中，点击插件的"详情"
2. 找到"检查视图"部分
3. 点击"后台页"或"弹出内容"来打开调试工具
4. 在调试工具中，可以查看控制台日志、调试代码等

#### 4. 使用详细日志

我们在代码中添加了详细的日志记录，可以帮助快速定位问题：

- 内容脚本日志前缀：`[AutoSave]`
- 后台脚本日志前缀：`[Background]`
- 组件日志前缀：`[AutoSave]`

在Chrome扩展程序调试工具的控制台中，可以查看这些日志。

### 单元测试

运行单元测试：

```bash
# 运行所有测试
npm run test

# 只运行扩展程序相关测试
npm run test:extension

# 监视模式运行测试
npm run test:watch
```

### 人工测试指南

#### 测试环境准备

1. 构建浏览器插件：
   ```bash
   npm run build:extension
   ```

2. 在Chrome中加载插件：
   - 打开Chrome浏览器
   - 访问 `chrome://extensions/`
   - 开启"开发者模式"
   - 点击"加载已解压的扩展程序"
   - 选择 `AetherFlow_plugin_front/dist` 目录

3. 打开支持的AI平台（ChatGPT、Claude或Bard）

#### 测试用例

##### 1. 自动保存开关测试

###### 测试步骤
1. 点击插件图标，打开插件弹出窗口
2. 点击导航栏中的"设置"选项卡
3. 找到"自动保存"开关
4. 切换开关状态（开启/关闭）
5. 返回到提示词库或提示词增强页面

###### 预期结果
- 当自动保存开关开启时，页面右下角应显示自动保存状态指示器
- 当自动保存开关关闭时，页面右下角不应显示自动保存状态指示器
- 开关状态应该被保存，刷新页面后仍然保持

##### 2. 自动保存功能测试

###### 测试步骤
1. 确保自动保存开关已开启
2. 打开支持的AI平台（如ChatGPT）
3. 发送一条消息给AI
4. 等待AI回复
5. 查看插件弹出窗口中的自动保存状态指示器

###### 预期结果
- 自动保存指示器应显示"保存中..."状态
- 几秒钟后，状态应变为"已保存 刚刚"
- 在Chrome扩展程序调试工具的控制台中，应该看到捕获和保存的日志

##### 3. 保存历史记录测试

###### 测试步骤
1. 确保自动保存开关已开启
2. 在AI平台上进行多轮对话
3. 打开插件弹出窗口
4. 点击页面右下角的自动保存指示器

###### 预期结果
- 应显示保存历史记录面板
- 面板中应列出最近的保存记录，包括时间戳和内容预览
- 点击"恢复"按钮应将对应的提示词加载到提示词增强页面

##### 4. 错误处理测试

###### 测试步骤
1. 确保自动保存开关已开启
2. 断开网络连接
3. 在AI平台上发送一条消息
4. 查看插件弹出窗口中的自动保存状态指示器

###### 预期结果
- 自动保存指示器应显示错误状态
- 在Chrome扩展程序调试工具的控制台中，应该看到错误日志
- 重新连接网络后，下一次自动保存应恢复正常

#### 测试结果记录

| 测试用例 | 测试日期 | 测试结果 | 备注 |
|---------|---------|---------|------|
| 1. 自动保存开关测试 | | | |
| 2. 自动保存功能测试 | | | |
| 3. 保存历史记录测试 | | | |
| 4. 错误处理测试 | | | |

### 问题记录

如果在测试过程中发现任何问题，请在此处记录：

1. 问题描述：
   - 复现步骤：
   - 预期行为：
   - 实际行为：
   - 可能的原因：
   - 日志信息：

2. 问题描述：
   - 复现步骤：
   - 预期行为：
   - 实际行为：
   - 可能的原因：
   - 日志信息：

## 浏览器插件测试

### 构建插件
```bash
# 进入插件目录
cd AetherFlow_v2/AetherFlow_plugin_front

# 安装依赖
npm install

# 构建插件
npm run build
```

### 加载插件
1. 打开Chrome浏览器
2. 访问 chrome://extensions/
3. 开启"开发者模式"（右上角开关）
4. 点击"加载已解压的扩展程序"
5. 选择 `AetherFlow_v2/AetherFlow_plugin_front/dist` 目录

## 问题排查指南

### 单元测试失败
- 检查测试环境配置是否正确
- 检查模拟数据和处理程序是否正确
- 检查测试用例中的断言是否合理
- 查看具体的错误信息，定位问题所在

### 后端服务启动失败
- 检查MongoDB是否已安装并启动（如果需要完整功能）
- 检查环境变量配置是否正确（.env文件）
- 检查端口是否被占用（默认3000端口）
- 检查日志输出，查找具体错误信息

### 前端服务启动失败
- 检查Node.js版本是否兼容（推荐使用v16+）
- 检查依赖是否正确安装
- 检查环境变量配置是否正确（.env文件）
- 检查vite配置是否正确

### 浏览器插件加载失败
- 检查构建是否成功，dist目录是否生成
- 检查manifest.json配置是否正确
- 检查浏览器版本是否兼容
- 查看浏览器控制台是否有错误信息

### 无法连接到服务
- 尝试使用IP地址代替localhost（如http://127.0.0.1:5173）
- 检查防火墙设置是否阻止了连接
- 尝试关闭杀毒软件或添加例外
- 检查网络适配器设置是否正确
- 尝试重启网络服务或计算机


