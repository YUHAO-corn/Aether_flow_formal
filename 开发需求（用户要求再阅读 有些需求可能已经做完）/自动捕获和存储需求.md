## 自动捕获/存储功能需求

### 功能描述
- ​**功能名称**: 自动存储系统
- ​**优先级**: P0
- ​**功能概述**: 当用户与AI平台进行对话时，系统自动捕获并存储最新的对话内容。

### 功能细节
1. ​**存储机制**:
   - ​**滚动存储**: 每个用户默认保留最近100条对话记录。
   - ​**超限处理**: 当未收藏的存储记录超过100条时，系统自动删除最旧的未收藏内容。
   - **收藏限制**：最多收藏100条对话

2. ​**触发条件**:
   - 用户每次在AI平台的输入框中提交对话内容时，系统自动捕获并存储该对话。

3. ​**存储内容**:
   - 捕获的对话内容包括用户输入的提示词（Prompt）和AI平台的回复。

4. ​**变量预留**:
   - 系统需预留变量，以便后续扩展存储容量或调整存储策略。

### 界面需求
- ​**自动存储提醒**:
  - 在界面底部显示小型浮动通知，提示用户最近一次对话已自动保存。
  - 点击通知可拉出列表，显示最近的存储记录。

### 技术实现
- ​**数据存储**:
  - 使用轻量级数据库或本地存储机制，确保数据快速存取。
- ​**性能优化**:
  - 确保存储操作不影响用户的主要浏览体验，避免因存储操作导致界面卡顿。

## 自动存储功能 - 技术难点与开源参考

---

### 技术难点与参考思路

#### 1. 实时捕获AI平台对话
- ​**难点**：不同AI平台（如ChatGPT、Claude等）的输入框DOM结构差异大，且可能动态生成  
- ​**解决方案**：  
  - 使用浏览器插件的`content_scripts`匹配目标平台URL特征  
  - 通过`MutationObserver`监听输入框DOM变化  
  - 捕获`beforeunload`/`submit`事件作为存储触发点  

#### 2. 高频存储性能优化
- ​**难点**：连续对话可能导致存储延迟  
- ​**解决方案**：  
  - 采用IndexedDB异步批量写入  
  - 实现LRU缓存机制，优先保留高频数据  
  - 使用Web Workers分离存储线程  

#### 3. 跨平台数据同步
- ​**难点**：浏览器本地存储无法跨浏览器同步  
- ​**解决方案**：  
  - 集成`chrome.storage.sync`（Chrome插件）  
  - 通过WebSocket实现实时同步（需服务端支持）  

---

### 开源项目参考（实时捕获相关）
**[ChatGPT-Exporter](https://github.com/pionxzh/chatgpt-exporter)**  
   - 核心能力：逆向解析OpenAI DOM结构  
   - 参考价值：  
     - 实现针对特定AI平台的选择器编写范式  
     - 增量式存储的时间窗口控制机制  

**[Bing Chat Exporter](https://github.com/defineprogramming/bing-chat-exporter)**  
   - 核心能力：动态内容流式捕获  
   - 参考价值：  
     - 处理分批次加载对话的技术方案  
     - 对话内容的结构化解析方法  

**[MutationObserver API](https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver)**  
   - 核心能力：动态DOM元素监听  
   - 参考价值：  
     - 通用型输入框捕获兜底方案（`childList`+`subtree`监听）  
     - 性能敏感的`disconnect()`/`observe()`调用策略  

**[DOMPurify](https://github.com/cure53/DOMPurify)**  
   - 核心能力：输入内容消毒  
   - 参考价值：  
     - 防范用户输入中的恶意脚本注入  
     - 保留AI回复中的安全HTML标签（如代码块）  

**[Chrome Extension Docs](https://developer.chrome.com/docs/extensions/)**  
   - 核心能力：浏览器插件架构  
   - 参考价值：  
     - 通过`manifest.json`声明捕获的AI平台URL模式（如`*://chat.openai.com/*`）  
     - 使用`chrome.storage`实现跨会话存储  

### 重点技术组合建议
1. ​**平台适配层**  
   - 基于Exporter项目的逆向工程经验，为每个目标AI平台编写专用选择器  
   - 通过MutationObserver监听动态生成的输入组件（如Claude的延迟加载对话框）  

2. ​**安全捕获流**  
   ```mermaid
   graph TD
     A[用户输入] --> B(DOMPurify消毒)
     B --> C{MutationObserver检测}
     C -->|新对话| D[结构化解析]
     D --> E[IndexedDB存储]

### 实现方式参考
- ​**分层捕获策略**：  
  基础层：通过`document.execCommand`捕获通用输入框  
  增强层：为Top10 AI平台编写定制化选择器  
- ​**降级方案**：  
  当自动捕获失败时，提供手动保存按钮（通过右键菜单/快捷键触发）  
- ​**隐私保护**：  
  对敏感字段（如API密钥）使用`Crypto.subtle`加密存储  

  ----
### 其他参考项目 
  1. ​**[Puppeteer](https://github.com/puppeteer/puppeteer)**  
   - 核心能力：Headless Chrome控制  
   - 参考价值：可用于测试环境模拟不同AI平台的DOM操作模式  

2. ​**[MutationObserver Shim](https://github.com/webmodules/mutation-observer)**  
   - 核心能力：跨浏览器兼容的DOM监听  
   - 参考价值：处理动态生成的输入框监听  

3. ​**[DOMPurify](https://github.com/cure53/DOMPurify)**  
   - 核心能力：安全的HTML净化  
   - 参考价值：捕获对话内容时的XSS防护  

4. ​**[RxJS](https://github.com/ReactiveX/rxjs)**  
   - 核心能力：响应式事件流处理  
   - 参考价值：管理高频输入事件节流（如用户连续输入时延迟存储）  

5. ​**[WebMidiLink](https://github.com/notwaldorf/web-midi-link)**  
   - 核心能力：跨标签页通信  
   - 参考价值：解决多标签页同时操作时的存储冲突  
### 开源项目参考（新增）

**[ChatGPT-Exporter](https://github.com/pionxzh/chatgpt-exporter)**  
   - 核心能力：精准捕获ChatGPT对话历史  
   - 参考价值：  
     - 通过逆向工程解析OpenAI的DOM结构  
     - 实现对话内容的增量式存储策略  

**[Bing Chat Exporter](https://github.com/defineprogramming/bing-chat-exporter)**  
   - 核心能力：实时抓取Bing Chat对话流  
   - 参考价值：  
     - 处理动态加载内容的滚动监听机制  
     - 对话内容的JSON结构化存储方案  

**[ChatALL](https://github.com/ai-shifu/ChatALL)**  
   - 核心能力：同时连接多个AI平台的聊天界面  
   - 参考价值：  
     - 跨平台DOM适配方案（支持ChatGPT/Claude/Bard等）  
     - 统一的事件捕获抽象层设计  

**[MutationObserver API](https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver)**  
   - 核心能力：监测DOM树动态变化  
   - 参考价值：  
     - 实现输入框动态生成的兜底监听  
     - 配合`attributeFilter`精准捕获内容变更  

**[Chrome Extension Documentation](https://developer.chrome.com/docs/extensions/)**  
   - 核心能力：浏览器插件开发规范  
   - 参考价值：  
     - `content_scripts`匹配AI平台URL模式  
     - 使用`storage.local`实现滚动存储限制  

**[ChatHub](https://github.com/chathub-dev/chathub)**  
   - 核心能力：聚合式AI聊天管理  
   - 参考价值：  
     - 跨平台对话数据的统一存储结构设计  
     - 自动清理重复/低质量对话的启发式算法  
---
